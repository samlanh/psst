<?php
	$tr = Application_Form_FrmLanguages::getCurrentlanguage();
	echo $this->headTitle($tr->translate("STUDENT_BEPATREPORT")); 
	$frm =  $this->form_search;
?>	
<style>
.hover:hover{ background:#ccc;}</style>
<div style="width: 30cm;margin: 0 auto;">
<form  id='foundation_class' action="" dojoType="dijit.form.Form" method="post" enctype="application/x-www-form-urlencoded">
		<table width="100%">
	       <tr>
	           <td><?php echo $frm->getElement("title");?></td>
	           <td><?php echo $frm->getElement("branch_id");?></td>
	           <td><?php echo $frm->getElement("study_year");?></td>
	           <td><?php echo $frm->getElement("degree");?></td>
	           <td><?php echo $frm->getElement("grade_all");?></td>
			</tr>
			<tr>
				<td><?php echo $frm->getElement("group");?></td>
				<td><?php echo $frm->getElement("session");?></td>
				<td><?php echo $frm->getElement("start_date");?></td>
				<td><?php echo $frm->getElement("end_date");?></td>
				<td>
					<select name="ordering" id="ordering" dojoType="dijit.form.FilteringSelect" class="fullside">
						<option value="1" <?php if($this->search['ordering']==1){echo"selected";}?>>Sort By Name A-Z</option>
						<option value="2" <?php if($this->search['ordering']==2){echo"selected";}?>>Sort By Registered Date ASC</option>
					</select>
				</td>
				<td><button class="button-class button-primary" iconClass="glyphicon glyphicon-search" dojoType="dijit.form.Button" showLabel="true" name="search"  type="submit"><?php echo $tr->translate("SEARCH");?></button></td>
		 	</tr>
		</table>		
</form>
</div>
	<div style="border: 1px dotted #000;background: #fff;min-width:29cm;margin: 0 auto;min-height: 27cm;padding: 0.5cm;">
		<div id="divPrint">
			<table border="0" style="background:#fff; margin: 0 auto; width: 100%; ">
				<tr>
					<td width="15%" align="center">
						<img style="width: 60%;" alt="<?php ?>" src="<?php echo $this->baseUrl().'/images/logo.png'?>"><br />
					</td>
					<td width="70%"  align="center">
						<ul>
							<li><strong​​ style=" font-weight:bold;font-family: Arial Black;color:#000; font-size: 17px;font-family:'Khmer MEF2';"><?php echo $tr->translate("CUSTOMER_BRANCH");?></strong></li>
							<li><strong​​ style=" font-weight:bold;font-family: Arial Black;color:#000; font-size: 17px;font-family:'Khmer MEF2';"><?php echo $tr->translate("STUDENT_BEPATREPORT");?></strong></li>
							<strong​​ style=" font-weight:bold;font-family: Arial Black;color:#000; font-size: 13px;font-family:'Khmer MEF2';"><?php if(!empty($this->search['start_date'])){?><?php echo date('d-M-Y',strtotime($this->search['start_date']));?> <?php echo $tr->translate("TO");?> <?php echo date('d-M-Y',strtotime($this->search['end_date']));}?> </strong>
						</ul>
					</td>
					<td width="15%" align="center">
					</td>
				</tr>
			<style>
				table tr th{
					border: 1px solid #000;	
				}
				ul li{list-style: none;}
			</style>
				<tr>
					<td colspan="3">
					<div id="exportExcel">
						<table cellpadding="4"​ style="font-family:'Khmer OS Battambang' ; margin:0 auto;width:100%;border:1px solid #000; border-collapse: collapse;white-space: nowrap;"  border="1" >
							<tr style="font-size:12px; height: 20px;background: #ccd9ff;" align="center" >
								<th rowspan="1"><?php echo $tr->translate("NUM");?></th>
								<th rowspan="1"><?php echo $tr->translate("STUDENT_NAME");?></th>
								<th rowspan="1"><?php echo $tr->translate("SEX");?></th>
								<th rowspan="1"><?php echo $tr->translate("TEL");?></th>
								<th rowspan="1"><?php echo $tr->translate("DATE_START_STUDY");?></th>
								<?php /*<th rowspan="1"><?php echo $tr->translate("Std Fee<br />/M");?></th>*/?>
								<th rowspan="1"><?php echo $tr->translate("% Scholar<br />/Y");?></th>
								<th rowspan="1"><?php echo $tr->translate("LATE_FEE");?></th>
								<th rowspan="1"><?php echo $tr->translate("DISCOUNT");?></th>
								
								<th rowspan="1"><?php echo $tr->translate("PAID_DATE");?></th>
								<th rowspan="1"><?php echo $tr->translate("RECEIPT_NO");?></th>
								<th rowspan="1"><?php echo $tr->translate("PAYMENT_TERM");?></th>
								<th rowspan="1"><?php echo $tr->translate("TOTAL");?></th>
								
								<th rowspan="1"><?php echo $tr->translate("PAID_AMOUNT");?></th>
								<th rowspan="1"><?php echo $tr->translate("START_DATE");?></th>
								<th rowspan="1"><?php echo $tr->translate("END_DATE");?></th>
								<th rowspan="1"><?php echo $tr->translate("NOTE");?></th>
							</tr>
						<?php $i=0;$degree=0;$group='';$count=0; foreach ($this->rs AS $key=>$row) { ?>
							
							<?php if($group!=$row['group_id'] && $key>0){ //&& $row['group_id']>0 ?>
									<tr>
										<td colspan="12"></td>
										<td colspan="2" align="center" style="font-size: 15px"><strong><?php echo $tr->translate("TOTAL");?></strong></td>
										<td colspan="2" align="center" style="font-size: 15px"><strong><?php echo $count;$count=0;$i=0; echo $tr->translate("STUDENT_UNIT");?></strong></td>
									</tr>
								</table>
								<table cellpadding="4"​ style="margin-top: 50px; font-family:'Khmer OS Battambang' ;width:100%;border:1px solid #000; border-collapse: collapse;white-space: nowrap;"  border="1" >	
									<tr style="font-size:12px; height: 20px;background: #ccd9ff;" align="center" >
										<th rowspan="1"><?php echo $tr->translate("NUM");?></th>
										<th rowspan="1"><?php echo $tr->translate("STUDENT_NAME");?></th>
										<th rowspan="1"><?php echo $tr->translate("SEX");?></th>
										<th rowspan="1"><?php echo $tr->translate("TEL");?></th>
										<th rowspan="1"><?php echo $tr->translate("DATE_START_STUDY");?></th>
										<?php /*<th rowspan="1"><?php echo $tr->translate("Std Fee<br />/M");?></th>*/?>
										<th rowspan="1"><?php echo $tr->translate("% Scholar<br />/Y");?></th>
										<th rowspan="1"><?php echo $tr->translate("LATE_FEE");?></th>
										<th rowspan="1"><?php echo $tr->translate("DISCOUNT");?></th>
										
										<th rowspan="1"><?php echo $tr->translate("PAID_DATE");?></th>
										<th rowspan="1"><?php echo $tr->translate("RECEIPT_NO");?></th>
										<th rowspan="1"><?php echo $tr->translate("PAYMENT_TERM");?></th>
										<th rowspan="1"><?php echo $tr->translate("TOTAL");?></th>
										
										<th rowspan="1"><?php echo $tr->translate("PAID_AMOUNT");?></th>
										<th rowspan="1"><?php echo $tr->translate("START_DATE");?></th>
										<th rowspan="1"><?php echo $tr->translate("END_DATE");?></th>
										<th rowspan="1"><?php echo $tr->translate("NOTE");?></th>
									</tr>
									<?php if($row['group_id']>0){?>
										<tr>
											<td colspan="16"> &nbsp; <strong>Group :</strong> <?php echo $row['group_name'];?> , <strong>Academic Year :</strong> <?php echo $row['academic_year'];?> , <strong>Degree :</strong> <?php echo $row['degree'];?> , <strong>Grade :</strong> <?php echo $row['grade'];?> , <strong>Session :</strong> <?php echo $row['session'];?></td> 			
										</tr>
									<?php }else{?>
										<tr>
											<td colspan="16"> &nbsp; <strong>Unknown Group</strong> </td>
										</tr>
									<?php }?>
							<?php }elseif($key==0){?>
									<?php if($row['group_id']>0){?>
									<tr>
										<td colspan="16"> &nbsp; <strong>Group :</strong> <?php echo $row['group_name'];?> , <strong>Academic Year :</strong> <?php echo $row['academic_year'];?> , <strong>Degree :</strong> <?php echo $row['degree'];?> , <strong>Grade :</strong> <?php echo $row['grade'];?> , <strong>Session :</strong> <?php echo $row['session'];?></td>
									</tr>
									<?php }else{?>
									<tr>
										<td colspan="16"> &nbsp; <strong>Unknown Group</strong> </td>
									</tr>
									<?php }?>
							<?php }?>
							
							<?php $i++;$count++; ?>
							
							<tr style="font-size:12px; height: 23px;" align="center" class="hover" >
								<td><?php echo $i;?></td>
								<td align="left">&nbsp;&nbsp;&nbsp;<?php echo !empty($row['stu_khname'])?$row['stu_khname']:$row['name'];?>&nbsp;</td>
								<td><?php echo $row['sex'];?></td>	
								<td><?php echo $row['tel'];?></td>
								<td><?php if($row['date_start_study']>0){echo date("d-m-Y",strtotime($row['date_start_study']));}?></td>
								<?php /*?>
								<td>$&nbsp;
									<?php 
										$tution_fee = $row['tuition_fee']/12;
										echo number_format($tution_fee,2);
									?>
								</td>
								*/?>
								<td>
									
								</td>
								<td align="center">&nbsp;<strong>&nbsp;<?php //if($row['late_fee']>0){echo "$".number_format($row['late_fee'],2);}?></strong></td>
								<?php 
									$discount = "";
									
								?>
								<td align="center">&nbsp;<strong>&nbsp;<?php //echo $discount;?></strong></td>
								
								
								<td align="center">&nbsp;<strong><?php if(!empty($row['create_date'])){echo date("d-m-Y",strtotime($row['create_date']));};?></strong></td>
								<td align="center">&nbsp;<strong><?php echo $row['receipt_number'];?></strong></td>
								
								<?php 
									$total_day=strtotime($row['validate'])-strtotime($row['start_date']);
									$day=(int)($total_day/(60*60*24));
									$qty_month = number_format($day/30);
									$qty_day = $day%30;
								?>
								<?php $payment_term=array("1"=>"Month","2"=>"Term","3"=>"Semester","4"=>"Annual","5"=>"Other",);?>
								<td align="center">
									<?php 
										if($row['payment_term']>0){
											if($row['payment_term']==5){
												if($qty_month>0){
													echo $qty_month." month+".$qty_day." days";
												}else{
													echo $qty_day." days";
												}
											}else{
												echo $payment_term[$row['payment_term']];
											}
										}
									?>
								</td>
								<td align="center">&nbsp;<strong>$&nbsp;<?php echo number_format($row['subtotal'],2);?></strong></td>
								
								<td align="center">&nbsp;<strong>$&nbsp;<?php echo number_format($row['paidamount'],2);?></strong></td>
								<td align="center">&nbsp;<strong><?php if(!empty($row['start_date'])){echo date("d-m-Y",strtotime($row['start_date']));};?></strong></td>
								<td align="center" <?php if(!empty($row['validate']) && strtotime($row['validate'])<strtotime(date("d-m-Y"))) {echo"style='background:red;'";}?>>&nbsp;<strong><?php if(!empty($row['validate'])){echo date("d-m-Y",strtotime($row['validate']));};?></strong></td>
								<td align="left">&nbsp;<?php echo $row['note'];?></td>
							</tr>
							<?php $group=$row['group_id'];?>
						<?php }?>	
							<tr>
								<td colspan="12"></td>
								<td colspan="2" align="center" style="font-size: 15px"><strong><?php echo $tr->translate("TOTAL");?></strong></td>
								<td colspan="2" align="center" style="font-size: 15px"><strong><?php echo $count;$count=0;$i=0; echo $tr->translate("STUDENT_UNIT");?></strong></td>
							</tr>
						</table>	
					</div>	
					</td>
				</tr>
				<tr>
					<td colspan="3">&nbsp;</td>
				</tr>
				<tr>
					<td colspan="3">&nbsp;</td>
				</tr>
				<tr >
					<td colspan="3" width="100%">
						<table width="100%" style="font-family:'Khmer OS Battambang';">
							<tr>
								<td  width="25%" align="center">
									<span style=" font-size: 14px;"><?php echo $tr->translate('VERIFIED_BY')?></span>
								</td>
								<td  width="50%">
									&nbsp;
								</td>
								<td align="center"  width="25%">
									<span style="font-size: 14px;text-align: right;"><?php echo $tr->translate('PREPARED_BY')?></span>
								</td>
							</tr>
						</table>
					</td>
				</tr>
			</table>
		</div>
	</div>	