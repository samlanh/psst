<?php
	$tr = Application_Form_FrmLanguages::getCurrentlanguage();
	echo $this->headTitle($tr->translate('Student Payment Report'));
	$base_url = Application_Form_FrmMessage::getUrl("/");
	$frm = $this->FormIncomeStatisticFilter;

?>
<style>
.hover:hover{ background:#ccc;}
table.content-data tr.style-head,
table.tb-footer tr.style-head {
   font-weight: bold !important;
}
</style>
<div style="min-height: 10cm; margin: 0 auto; padding: 0.2cm 0.2cm 0cm 0.2cm">
	<div class="card-box">
			<div class="col-sm-12 border-botom">
				<div class="col-sm-8 pd-0">
					<h4 class="m-b-0">
						<i class="fa fa-file"></i>&nbsp;&nbsp;&nbsp;<?php echo $tr->translate("Student Payment Report");?></h4>
				</div>
				<div class="col-sm-4 text-right"></div>
			</div>
		</div>				
				<form id="list" name="list" action="" dojoType="dijit.form.Form" method="post">
					<div class="form-group">
							<div class="col-md-2 col-sm-2 col-xs-12">
								<?php echo $frm->getElement("adv_search");?>
							</div>
							<div class="col-md-2 col-sm-2 col-xs-12">
								<?php echo $frm->getElement('branch_id');?>
							</div>
							<div class="col-md-2 col-sm-2 col-xs-12">
								<?php echo $frm->getElement('degree');?>
							</div>
							<div class="col-md-2 col-sm-2 col-xs-12">
								<input id="grade" />
							</div>
							<div class="col-md-2 col-sm-2 col-xs-12">
								<?php echo $frm->getElement('pay_term');?>
							</div>
							<div class="col-md-2 col-sm-2 col-xs-12">
								<?php echo $frm->getElement('status');?>
							</div>
						</div>
						<div class="form-group">
							<div class="col-md-2 col-sm-2 col-xs-12">
								<?php echo $frm->getElement('start_date');?>
							</div>
							<div class="col-md-2 col-sm-2 col-xs-12">
								<?php echo $frm->getElement('studentType');?>
							</div>
							<div class="col-md-2 col-sm-2 col-xs-12">
								<?php echo $frm->getElement('payment_date');?>
							</div>
							<div class="col-md-2 col-sm-2 col-xs-12">	
								<button class="button-class button-primary" iconClass="glyphicon glyphicon-search" dojoType="dijit.form.Button" showLabel="true" type="submit"><?php echo $tr->translate("SEARCH");?></button>
							</div>
						</div>
					</form>
			
	<div class="card-body">
		<div id="divPrint">
			<style>
				#footer{display: none;}
					table.content-data {page-break-inside:auto; font-family:'Times New Roman','Khmer OS Battambang'; }
					tr.content-data{ page-break-inside:avoid; page-break-after:auto; }
					#header {
					  display: table-header-group;
					  page-break-inside:avoid; page-break-after:auto;
					}	
					td{ padding: 1px !important;}
					tr.line td{ border-bottom: 2px solid #000;padding-top: 5px; }
					table.content-data{
						border-collapse:collapse;
						width:100%;
						border:1px solid #000; 
						font-family:'Times New Roman','Khmer OS Battambang';
						font-size:11px;
						white-space: nowrap;
						margin:0 auto;
						color:#000;
						margin:0 auto;
					}
					table.content-data  tr.style-head {
					   line-height: 25px; padding:1px 0px; white-space: nowrap;height: 22px; 
						background: #CCD9FF;
						text-align: center;
					}
					table.content-data tr td{
						padding: 2px;
					}
					table.content-data tr.style-rowdata {
						font-size:11px; 
						height: 23px;
					}
					.greycolor{background-color:#dddd;}
					.right{text-align: right;}
					tr.noborder{ border: 1px solid #fff;border-top: 1px solid #000;}
					td.btmborder{border-bottom: 2px solid #000;font-weight:bold;}
				</style>	
			<table  style="background:#fff; margin: 0 auto; ;white-space: nowrap;width: 100%">
				<tr>
					<td colspan="3"><?php echo $this->rsheader;?></td>
				</tr>
				<tr>
					<td width="15%" align="center">
					</td>
					<td width="70%" align="center">
						<span style="color:#000; font-size: 12px;font-family:'Times New Roman','Khmer OS Muol Light';"><?php echo $tr->translate('Student Payment Report')?></span><br />
						<span style="color:#000; font-size: 12px;font-family:'Times New Roman','Khmer OS Muol Light';"><?php echo date("d-M-Y");?></span>
					</td>
					<td width="15%" align="center"></td>
				</tr>
				<tr>
					<td colspan="3" id="exportExcel">
							<table class="content-data" border="1">
								<thead>
									<tr class="style-head" align="center">
										<td rowspan="2"><?php echo $tr->translate("N_O");?></td>
										<td rowspan="2"><?php echo $tr->translate("BRANCH");?></td>
										<td rowspan="2"><?php echo $tr->translate("STUDENT_CODE");?></td>
										<td rowspan="2"><?php echo $tr->translate("STUDENT_NAME");?></td>
										<td rowspan="2"><?php echo $tr->translate("Phone Number");?></td>
										<td rowspan="2"><?php echo $tr->translate("Type");?></td>
										<td rowspan="2"><?php echo $tr->translate("Grade");?></td>
										<td rowspan="2"><?php echo $tr->translate("Registration Date");?></td>
										<td rowspan="2"><?php echo $tr->translate("Pay Type");?></td>
										<td colspan="2"><?php echo $tr->translate("Term1");?></td​>
										<td colspan="2"><?php echo $tr->translate("Term2");?></td>
										<td colspan="2"><?php echo $tr->translate("Term3");?></td>
										<td colspan="2"><?php echo $tr->translate("Term4");?></td>
									</tr>
									<tr class="style-head" align="center">
										<td><?php echo $tr->translate("Date");?></td>
										<td><?php echo $tr->translate("Amount");?></td>
										<td><?php echo $tr->translate("Date");?></td>
										<td><?php echo $tr->translate("Amount");?></td>
										<td><?php echo $tr->translate("Date");?></td​>
										<td><?php echo $tr->translate("Amount");?></td>
										<td><?php echo $tr->translate("Date");?></td>
										<td><?php echo $tr->translate("Amount");?></td>
									</tr>
								</thead>
								<?php $num=1; 
									$totalTerm1 = 0;
									$totalTerm2 = 0;
									$totalTerm3 = 0;
									$totalTerm4 = 0;
								if(!empty($this->dataPayment)){ foreach($this->dataPayment as $key=>$rs){
								?>
								<tr class="style-rowdata hover" align="center">
									<td><?php echo $key+1; ?></td>
									<td align="left"><?php echo $rs['branch_name']; ?></td>
									<td align="left"><?php echo $rs['stu_code']; ?></td>
									<td align="left"><?php echo $rs['student_name']; ?></td>
									<td align="left"><?php echo $rs['tel']; ?></td>
									<td align="left"><?php echo $rs['studentType']; ?></td>
									<td align="left"><?php echo $rs['grade']; ?></td>
									<td align="left"><?php echo $rs['registrationDate']; ?></td>
									<?php
										$resultPayment = $rs['paymentList'];

										$totalTerm1 +=  ($resultPayment['payment1']!='')?$resultPayment['payment1']:0;
										$totalTerm2 +=  ($resultPayment['payment2']!='')?$resultPayment['payment2']:0;
										$totalTerm3 +=  ($resultPayment['payment3']!='')?$resultPayment['payment3']:0;
										$totalTerm4 +=  ($resultPayment['payment4']!='')?$resultPayment['payment4']:0;
									?>
									<td align="center"><?php echo $resultPayment['stpaymentType'];?></td>
									<td class="<?php echo ($resultPayment['term1'] == 1) ? "" : "greycolor"; ?>"><?php echo !empty($resultPayment['periodDate1'])?date('d/m/Y',strtotime($resultPayment['periodDate1'])):""; ?></td>
									<td class="<?php echo($resultPayment['term1'] == 1) ? "" : "greycolor"; ?>"><?php echo ($resultPayment['payment1']!='')?number_format($resultPayment['payment1'],2):''; ?></td>
									<td class="<?php echo($resultPayment['term2'] == 1) ? "" : "greycolor"; ?>"><?php echo !empty($resultPayment['periodDate2'])?date('d/m/Y',strtotime($resultPayment['periodDate2'])):""; ?></td>
									<td class="<?php echo($resultPayment['term2'] == 1) ? "" : "greycolor"; ?>" align="right"><?php echo ($resultPayment['payment2']!='')?number_format($resultPayment['payment2'],2):''; ?></td>
									<td class="<?php echo($resultPayment['term3'] == 1) ? "" : "greycolor"; ?>" ><?php echo !empty($resultPayment['periodDate3'])?date('d/m/Y',strtotime($resultPayment['periodDate3'])):""; ?></td>
									<td class="<?php echo($resultPayment['term3'] == 1) ? "" : "greycolor"; ?>" align="right"><?php echo ($resultPayment['payment3']!='')?number_format($resultPayment['payment3'],2):''; ?></td>
									<td class="<?php echo($resultPayment['term4'] == 1) ? "" : "greycolor"; ?>"><?php echo !empty($resultPayment['periodDate4'])?date('d/m/Y',strtotime($resultPayment['periodDate4'])):""; ?></td>
									<td class="<?php echo($resultPayment['term4'] == 1) ? "" : "greycolor"; ?>" align="right"><?php echo ($resultPayment['payment4']!='')?number_format($resultPayment['payment4'],2):''; ?></td>
								</tr>
								<?php
								}}
								?>
								<tr class="noborder">
									<td colspan="10"></td>
									<td class="right btmborder"><?php echo number_format($totalTerm1, 2); ?></td>
									<td></td>
									<td class="right btmborder"><?php echo number_format($totalTerm2, 2); ?></td>
									<td></td>
									<td class="right btmborder"><?php echo number_format($totalTerm3, 2); ?></td>
									<td></td>
									<td class="right btmborder"><?php echo number_format($totalTerm4, 2); ?></td>
								</tr>
							</table>
					</td>
				</tr>
				<tr>
					<td colspan="3" width="100%">
						<?php echo $this->rsfooteracc;?>
					</td>
				</tr>
			</table>
		</div>	
	</div>	
</div>

<script src="<?php echo $this->baseUrl(); ?>/js/help.js" type="text/javascript"></script>
<script>
	dojo.require("dojo.data.ItemFileWriteStore");
	dojo.ready(function() {
		new dijit.form.FilteringSelect({
			queryExpr: "*${0}*",
			autoComplete: false,
			required: false,
			id: "grade",
			name: "grade",
			class: 'fullside',
			placeHolder: '<?php echo $tr->translate('GRADE');?>',
			onChange: function() {

			}
		}, "grade");

		degree = dijit.byId('degree');
		degree.on('change', function(evt) {
			getallGrade();
		});
		getallGrade();
	});

	var url_dept = '<?php echo $this->url(array('module' => 'global', 'controller' => 'grade', 'action' => 'get-grade')); ?>';

	function getallGrade() {
		dept_id = dijit.byId('degree').get('value');
		if (dept_id == '') {
			return false;
		}
		dojo.xhrPost({
			url: url_dept,
			content: {
				'dept_id': dept_id,
				'noaddnew': 1
			},
			handleAs: "json",
			load: function(data) {
				grade_store = getDataStorefromJSON('id', 'name', data);
				dijit.byId('grade').set('store', grade_store);
				dijit.byId('grade').attr('value', '<?php echo $this->search['grade'] ?>');
			},
			error: function(err) {
			}
		});
	}
</script>