<?php
	$tr = Application_Form_FrmLanguages::getCurrentlanguage();
	echo $this->headTitle('Student Payment Report');
	$base_url = Application_Form_FrmMessage::getUrl("/");
	$frm = $this->FormIncomeStatisticFilter;
	if($this->search['reportType']==1){
		$lblReport = "(Tuition Fee)";
	}elseif($this->search['reportType']==2){
		$lblReport = "(Lunch Fee)";
	}else{
		$lblReport = "(Nap Fee)";
	}
	
	$termOption = array(
				"Term" =>0,
				"Semester" =>0,
				"Year" =>0,
		);
?>
<style>
.hover:hover{ background:#ccc;}
table.content-data tr.style-head,
table.tb-footer tr.style-head {
   font-weight: bold !important;
}
.form-check-input{display: inline;}
</style>
<div style="min-height: 10cm; margin: 0 auto; padding: 0.2cm 0.2cm 0cm 0.2cm">
<form id="list" name="list" action="" dojoType="dijit.form.Form" method="post">
	<div class="card-box">
			<div class="col-sm-12 border-botom">
				<div class="col-sm-3 pd-0">
					<h4 class="m-b-0">
						<i class="fa fa-file"></i>&nbsp;&nbsp;&nbsp;Student Payment Report</h4>
				</div>
				<div class="col-sm-6 text-right">
					<div class="row g-12">
						<div class="col-md-3 col-sm-3 col-xs-12">
							<div class="form-check form-check-primary mt-1">
								<input class="form-check-input checkbox" type="radio" value="1" id="reportType" name="reportType"
									<?php echo ($this->search['reportType']==1)?"checked='checked'":'';?>> 
								<label class="form-check-label">Tuition Fee</label>
							</div>
						</div>
						<div class="col-md-3 col-sm-3 col-xs-12">
							<div class="form-check form-check-primary mt-1">
								<input class="form-check-input checkbox" type="radio" value="2" id="reportType" name="reportType"
								<?php echo ($this->search['reportType']==2)?"checked='checked'":'';?>> 
								<label class="form-check-label">Lunch Fee</label>
							</div>
						</div>
						<div class="col-md-3 col-sm-3 col-xs-12">
							<div class="form-check form-check-primary mt-1">
								<input class="form-check-input checkbox" type="radio" value="3" id="reportType" name="reportType"
								<?php echo ($this->search['reportType']==3)?"checked='checked'":'';?>> 
								<label class="form-check-label">Nap Fee</label>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>				
			<div class="form-group">
				<div class="col-md-2 col-sm-2 col-xs-12">
					<?php echo $frm->getElement("adv_search");?>
				</div>
				<div class="col-md-2 col-sm-2 col-xs-12">
					<?php echo $frm->getElement('branch_id');?>
				</div>
				<div class="col-md-2 col-sm-2 col-xs-12">
					<?php echo $frm->getElement('academic_year'); ?>
				</div>
				<div class="col-md-2 col-sm-2 col-xs-12">
					<?php echo $frm->getElement('degree');?>
				</div>
				<div class="col-md-2 col-sm-2 col-xs-12">
					<input id="grade" />
				</div>
				<div class="col-md-2 col-sm-2 col-xs-12">
				</div>
			</div>
			<div class="form-group">
				<div class="col-md-2 col-sm-2 col-xs-12">
					<?php echo $frm->getElement('studentType'); ?>
				</div>		
				<div class="col-md-2 col-sm-2 col-xs-12">
					<?php echo $frm->getElement('start_date'); ?>
				</div>
				<div class="col-md-2 col-sm-2 col-xs-12">
					<?php echo $frm->getElement('end_date'); ?>
				</div>
				<div class="col-md-2 col-sm-2 col-xs-12">
					<?php echo $frm->getElement('active_type'); ?>
				</div>
				<div class="col-md-2 col-sm-2 col-xs-12">
					<?php echo $frm->getElement('pay_term'); ?>
				</div>
			</div>
			<div class="form-group">
					<div class="col-md-4 col-sm-4 col-xs-12"></div>
					<div class="col-md-2 col-sm-2 col-xs-12">
						<?php echo $frm->getElement('paymentstatus'); ?>
					</div>
					<div class="col-md-2 col-sm-2 col-xs-12">
						<?php echo $frm->getElement('termList'); ?>
					</div>
					<div class="col-md-2 col-sm-2 col-xs-12">
						<?php echo $frm->getElement('payment_date'); ?>
					</div>
					<div class="col-md-2 col-sm-2 col-xs-12">	
						<button class="button-class button-primary" iconClass="glyphicon glyphicon-search" dojoType="dijit.form.Button" showLabel="true" type="submit">Search</button>
					</div>
			</div>
		</form>
	<div class="card-body">
		<div id="divPrint">
			<style>
				#footer{display: none;}
					table.content-data {page-break-inside:auto; font-family:'Times New Roman','Khmer OS Battambang'; }
					tr.content-data{ page-break-inside:avoid; page-break-after:auto; }
					#header {
					  display: table-header-group;
					  page-break-inside:avoid; page-break-after:auto;
					}	
					td{ padding: 1px !important;}
					tr.line td{ border-bottom: 2px solid #000;padding-top: 5px; }
					table.content-data{
						border-collapse:collapse;
						width:100%;
						border:1px solid #000; 
						font-family:'Times New Roman','Khmer OS Battambang';
						font-size:11px;
						white-space: nowrap;
						margin:0 auto;
						color:#000;
						margin:0 auto;
					}
					table.content-data  tr.style-head {
					   line-height: 25px; padding:1px 0px; white-space: nowrap;height: 22px; 
						background: #CCD9FF;
						text-align: center;
					}
					table.content-data tr td{
						padding: 2px;
					}
					table.content-data tr.style-rowdata {
						font-size:11px; 
						height: 23px;
					}
					.greycolor{background-color:#dddd;}
					.right{text-align: right;}
					tr.noborder{ border: 1px solid #fff;border-top: 1px solid #000;}
					td.btmborder{border-bottom: 2px solid #000;font-weight:bold;}
					.fixedwidth td{width: 50px;}
					.width-contact{width:150px;word-break: break-all;white-space:normal;}
					.widthstudent{width: 150px; white-space:pre-line;}
					
					table.content-data tbody td span.text-truncate {
						overflow: hidden;
						text-overflow: ellipsis;
						white-space: nowrap;
						line-height: inherit;
						width: 100px;
						display: block;
					}
					.widthCol-px-30{
						width: 30px !important;
					}
					.widthCol-px-40{
						width: 40px !important;
					}
					.widthCol-px-50{
						width: 50px !important;
					}
					.widthCol-px-60{
						width: 60px !important;
					}
					.widthCol-px-70{
						width: 70px !important;
					}
					.widthCol-px-100{
						width: 100px !important;
					}
					.widthCol-px-120{
						width: 120px !important;
					}
					@media print {
						<?php if(!empty($this->printFormat)){ echo $this->printFormat; } ?>
						
					}
				</style>	
			<table  style="background:#fff; margin: 0 auto; ;white-space: nowrap;width: 100%">
				<tr>
					<td colspan="3"><?php echo $this->rsheader;?></td>
				</tr>
				<tr>
					<td width="15%" align="center">
					</td>
					<td width="70%" align="center">
						<span style="color:#000; font-size: 12px;font-family:'Times New Roman','Khmer OS Muol Light';">Student Payment Report</span><br />
						<span style="color:#000; font-size: 12px;font-family:'Times New Roman','Khmer OS Muol Light';"><label id="lblreportType"></label><br /></span>
						<span style="color:#000; font-size: 12px;font-family:'Times New Roman','Khmer OS Muol Light';"><?php echo date("d-M-y");?></span>
					</td>
					<td width="15%" align="center"></td>
				</tr>
				<tr>
					<td colspan="3" id="exportExcel">
					<table class="content-data" border="1">
								<thead>
									<tr class="style-head" align="center">
										<td rowspan="2">No.</td>
										<td rowspan="2">Branch</td>
										<td rowspan="2">Student Id</td>
										<td class="widthCol-px-70" rowspan="2">Student</td>
										<td class="widthCol-px-70" rowspan="2">Phone Number</td>
										<td class="widthCol-px-50" rowspan="2">Student Type</td>
										<td rowspan="2">Status</td>
										<td rowspan="2">Grade</td>
										<td rowspan="2">Registration</td>
										<td class="widthCol-px-40" rowspan="2">Discount</td>
										<td rowspan="2">Pay Type</td>
										<td colspan="2">Term1</td>
										<td colspan="2">Term2</td>
										<td colspan="2">Term3</td>
										<td colspan="2">Term4</td>
									</tr>
									<tr class="style-head fixedwidth" align="center">
										<td class="widthCol-px-70" >Date</td>
										<td class="widthCol-px-70" >Amount</td>
										<td class="widthCol-px-70" >Date</td>
										<td class="widthCol-px-70" >Amount</td>
										<td class="widthCol-px-70" >Date</td>
										<td class="widthCol-px-70" >Amount</td>
										<td class="widthCol-px-70" >Date</td>
										<td class="widthCol-px-70" >Amount</td>
									</tr>
								</thead>
								<?php 
								
								$summaryInfoArray = array();
								$num=1; 
									$totalTerm1 = 0;
									$totalTerm2 = 0;
									$totalTerm3 = 0;
									$totalTerm4 = 0;
								$num = 0;
								if(!empty($this->dataPayment)){ foreach($this->dataPayment as $key=>$rs){
									
									if(!empty($rs['stpaymentType'])){
										if(isset($termOption[$rs['stpaymentType']])){
											$termOption[$rs['stpaymentType']] = $termOption[$rs['stpaymentType']] +1;
										}
									}
									
								?>
								<tr class="style-rowdata hover" align="center">
									<td><?php echo $num+=1; ?></td>
									<td align="left"><?php echo $rs['branch_name']; ?></td>
									<td align="left"><?php echo $rs['stu_code']; ?></td>
									<td align="left"><span class="widthCol-px-70"><?php echo $rs['student_name']; ?></span></td>
									<td align="left"><span class="widthCol-px-70 text-truncate"><?php echo $rs['tel']; ?></span></td>
									<td align="left"><span class="widthCol-px-50 text-truncate"><?php echo $rs['studentType']; ?></span></td>
									<td><?php echo $rs['stopType']!=0?'x':''; ?></td>
									<td><?php echo $rs['grade']; ?></td>
									<td><?php echo $rs['registrationDate']; ?></td>
									<?php
										$resultPayment = $rs['paymentList'];
										$totalTerm1 +=  ($resultPayment['payment1']!='')?$resultPayment['payment1']:0;
										$totalTerm2 +=  ($resultPayment['payment2']!='')?$resultPayment['payment2']:0;
										$totalTerm3 +=  ($resultPayment['payment3']!='')?$resultPayment['payment3']:0;
										$totalTerm4 +=  ($resultPayment['payment4']!='')?$resultPayment['payment4']:0;
									?>
									<td><span class="widthCol-px-40"><?php echo $rs['discountCode']; ?></span></td>
									<td align="left"><?php echo $rs['stpaymentType'];?></td>
									<?php
										$resultPayment['term1'] = empty(($resultPayment['payment1'])) ? $resultPayment['term1'] : 0;
										$resultPayment['term2'] = empty(($resultPayment['payment2'])) ? $resultPayment['term2'] : 0;
										$resultPayment['term3'] = empty(($resultPayment['payment3'])) ? $resultPayment['term3'] : 0;
										$resultPayment['term4'] = empty(($resultPayment['payment4'])) ? $resultPayment['term4'] : 0;
									?>
									<td class="<?php echo($resultPayment['term1'] == 1) ? "greycolor" : ""; ?>"><?php echo !empty($resultPayment['periodDate1'])?date('d/m/y',strtotime($resultPayment['periodDate1'])):""; ?></td>
									<td class="<?php echo($resultPayment['term1'] == 1) ? "greycolor" : ""; ?>"><?php echo ($resultPayment['payment1']!='')?number_format($resultPayment['payment1'],2):''; ?></td>
									<td class="<?php echo($resultPayment['term2'] == 1) ? "greycolor" : ""; ?>"><?php echo !empty($resultPayment['periodDate2'])?date('d/m/y',strtotime($resultPayment['periodDate2'])):""; ?></td>
									<td class="<?php echo($resultPayment['term2'] == 1) ? "greycolor" : ""; ?>" align="right"><?php echo ($resultPayment['payment2']!='')?number_format($resultPayment['payment2'],2):''; ?></td>
									<td class="<?php echo($resultPayment['term3'] == 1) ? "greycolor" : ""; ?>" ><?php echo !empty($resultPayment['periodDate3'])?date('d/m/y',strtotime($resultPayment['periodDate3'])):""; ?></td>
									<td class="<?php echo($resultPayment['term3'] == 1) ? "greycolor" : ""; ?>" align="right"><?php echo ($resultPayment['payment3']!='')?number_format($resultPayment['payment3'],2):''; ?></td>
									<td class="<?php echo($resultPayment['term4'] == 1) ? "greycolor" : ""; ?>"><?php echo !empty($resultPayment['periodDate4'])?date('d/m/y',strtotime($resultPayment['periodDate4'])):""; ?></td>
									<td class="<?php echo($resultPayment['term4'] == 1) ? "greycolor" : ""; ?>" align="right"><?php echo ($resultPayment['payment4']!='')?number_format($resultPayment['payment4'],2):''; ?></td>
								</tr>
								<?php
								}}
								?>
								<tr class="noborder">
									<td colspan="12"></td>
									<td class="right btmborder"><?php echo number_format($totalTerm1, 2); ?></td>
									<td></td>
									<td class="right btmborder"><?php echo number_format($totalTerm2, 2); ?></td>
									<td></td>
									<td class="right btmborder"><?php echo number_format($totalTerm3, 2); ?></td>
									<td></td>
									<td class="right btmborder"><?php echo number_format($totalTerm4, 2); ?></td>
								</tr>
								<?php
								if(!empty($termOption)){
									$totalPaid = 0;
									$strSubTable='
									<tr class="noborder">
										<td colspan="12"></td>
										<td colspan="7" style="padding-top: 5px !important;">
									';
									
									$strColhead='<tr class="noborder" style="background-color :#c1d0f3;border: solid 1px #fff;"> ';
									
									$strColVal='<tr class="noborder">';
									foreach($termOption AS $thisKey =>$thisVal){
										$totalPaid += $thisVal;
										$strColhead.='
											<td class="center" width="33.33%">'.$thisKey.'</td>
										';
										$strColVal.='
											<td class="center bold">'.sprintf('%02d', $thisVal).'</td>
										';
									}
									$strColhead.='<td class="center bold">Total</td>';
									$strColVal.='
											<td class="center bold">'.sprintf('%02d', $totalPaid).'</td>
										';
									$strSubTable.='
											<table class="content-data" style=" text-align: center; margin: 0 auto; font-weight: bold; border: 0;">
												<tbody>
												
												'.$strColhead.'
												'.$strColVal.'
												</tbody>
											</table>
										';
									$strSubTable.='</td>
									</tr>';
									
									$strColhead.='</tr>';
									$strColVal.='</tr>';
									
										
									echo $strSubTable;
								}
								?>
							</table>
					</td>
				</tr>
				<tr>
					<td colspan="3" width="100%">
						<?php echo $this->rsfooteracc;?>
					</td>
				</tr>
			</table>
		</div>	
	</div>	
</div>

<script src="<?php echo $this->baseUrl(); ?>/js/help.js" type="text/javascript"></script>
<script>
	dojo.require("dojo.data.ItemFileWriteStore");
	require(["dojo/ready"], function (ready) {
		$('#lblreportType').html("<?php echo $lblReport; ?>");
		new dijit.form.FilteringSelect({
			queryExpr: "*${0}*",
			autoComplete: false,
			required: false,
			id: "grade",
			name: "grade",
			class: 'fullside',
			placeHolder: 'Grade',
			onChange: function() {

			}
		}, "grade");

		degree = dijit.byId('degree');
		degree.on('change', function(evt) {
			getallGrade();
		});
		getallGrade();
	});

	var url_dept = '<?php echo $this->url(array('module' => 'global', 'controller' => 'grade', 'action' => 'get-grade')); ?>';

	function getallGrade() {
		dept_id = dijit.byId('degree').get('value');
		if (dept_id == '') {
			return false;
		}
		dojo.xhrPost({
			url: url_dept,
			content: {
				'dept_id': dept_id,
				'noaddnew': 1
			},
			handleAs: "json",
			load: function(data) {
				grade_store = getDataStorefromJSON('id', 'name', data);
				dijit.byId('grade').set('store', grade_store);
				dijit.byId('grade').attr('value', '<?php echo $this->search['grade'] ?>');
			},
			error: function(err) {
			}
		});
	}
</script>