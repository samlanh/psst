<?php
	$tr = Application_Form_FrmLanguages::getCurrentlanguage();
	echo $this->headTitle($tr->translate('ADD_INITIZE_QTY')); 
	$base_url = Application_Form_FrmMessage::getUrl("/");
?>	
<style>
select{ width:100%;}
fieldset{  background:none;}
.red{ color: red; padding-left:5px;}
</style>
<div class="card">
	<div class="card-content collapse show">
		<div class="card-box">
           <div class="col-sm-12 border-botom">
		   		<div class="col-sm-8 pd-0">
		    		<h4 class="m-b-0"><i class="fa fa-cubes " aria-hidden="true"></i>&nbsp;&nbsp;&nbsp;<?php echo $tr->translate('សម្រង់ពិន្ទុសិស្ស');?></h4>
    			</div>
    			<div class="col-sm-4 text-right">
    			</div>
    		</div>
    	</div>
    	<form id='suspend_service' action="" dojoType="dijit.form.Form" method="post" enctype="multipart/form-data">
			<script type="dojo/method" event="onSubmit">			
				if(this.validate()) {
 					stu_id=dijit.byId("stu_id").get('value');
					if(stu_id=='' || stu_id==null){
						dijit.byId("stu_id").focus();
						return false;
					}
                	dijit.byId("save_close").attr("disabled",true);
					dijit.byId("save_new").attr("disabled",true);
					return true;
				} else {
					return false;
				}
				</script>
			<div class="card-box">
				<div class="col-md-3 col-sm-3 col-xs-12">
					<div class="card-blogform">
								<div class="card-body"> 
									<div class="row"> 
										<div class="col-md-12 col-sm-12 col-xs-12">

											<div class="d-flex "> 
												<div class="settings-main-icon ">
													<i class="glyphicon glyphicon-queen" aria-hidden="true"></i>
												</div> 
												<div class="col-md-10 col-sm-10 col-xs-12"> 
													<p class="tx-20 font-weight-semibold d-flex "><?php echo $tr->translate("BRANCH_INFO");?></p>
												</div> 
											</div>
											<div class="col-md-12 col-sm-12 col-xs-12">
													&nbsp;
											</div>

											
												<div class="form-group">
												<label class="control-label bold col-md-5 col-sm-5 col-xs-12" ><?php echo $tr->translate("BRANCH");?> <span class="required">*</span>
												</label>
												<div class="col-md-7 col-sm-7 col-xs-12">
														<select autoComplete="false" queryExpr="*${0}*" dojoType="dijit.form.FilteringSelect"   class="fullside" id="branch" name="branch" type="text" onchange="getStudentByBranch(); 
														">								
															<?php if(!empty($this->branchopt)) foreach ($this->branchopt As $key=>$branch){?>
																	<option value="#" >ជ្រើសរើសសាខា</option>
																	<option value="<?php echo $branch['id']?>" ><?php echo $branch['name'];?></option>
															<?php }?> 
														</select>
												</div>
												</div>
												<div class="form-group">
												<label class="control-label bold col-md-5 col-sm-5 col-xs-12" ><?php echo $tr->translate("DATE");?> <span class="required">*</span>
												</label>
												<div class="col-md-7 col-sm-7 col-xs-12">
														<input class="fullside" constraints="{datePattern:'dd/MM/yyyy'}" tabindex="5"  name="create_date" id="create_date" dojoType="dijit.form.DateTextBox"  value="<?php echo date('Y-m-d');?>" type="text"/>
												</div>
												</div>
												
												<div class="form-group">
												<label class="control-label bold col-md-5 col-sm-5 col-xs-12" ><?php echo $tr->translate("NOTE");?>
												</label>
												<div class="col-md-7 col-sm-7 col-xs-12">
														<textarea class="fullside"  style=" height: 70px !important;" tabindex="20" dojoType=""  id="note" name="note"  ></textarea>
												</div>
												</div>	

										</div>
									</div>
								</div>
					</div>
			

						
	            </div>
	            <div class="col-md-9 col-sm-9 col-xs-12">
					<div class="card-blogform">
								<div class="card-body"> 
									<div class="row"> 
										<div class="col-md-12 col-sm-12 col-xs-12">

											<div class="d-flex "> 
												<div class="settings-main-icon ">
													<i class="glyphicon glyphicon-education" aria-hidden="true"></i>
												</div> 
												<div class="col-md-10 col-sm-10 col-xs-12"> 
													<p class="tx-20 font-weight-semibold d-flex "><?php echo $tr->translate("សម្រង់ពិន្ទុសិស្ស");?></p>
												</div> 
											</div>
											<div class="col-md-12 col-sm-12 col-xs-12">
											&nbsp;
							
											</div>

											<div class="form-group" style="background: #d8e0e2;padding: 5px 15px;margin: 0;border: solid 1px #697996;border-radius: 2px;margin-top: 10px;">
												<label class="control-label bold col-md-4 col-sm-4 col-xs-12"><?php echo $tr->translate("SELECT_STUDENT");?> 
												</label>
													<div class="col-md-5 col-sm-5 col-xs-12">
															<input id="stu_id" name="stu_id" />
													</div>
													<div class="col-md-3 col-sm-3 col-xs-12">
														<input class="button-class button-primary" iconClass="glyphicon glyphicon-refresh" type="button" label="<?php echo $tr->translate('REFRESH');?>" dojoType="dijit.form.Button" onclick="getStudentByBranch();"/>
													</div>
													<div class="clearfix"></div>
												</div>
												<div class="form-group">
													<table  style="width:100%; border-collapse: collapse; border:1px solid #ccc;">
														<thead>
															<tr id="head-title" class="head-td" align="right"></tr>
														</thead>
														<tbody id="table_row"></tbody>
													</table>
													<input  id="identity" name="identity" />
													<input  id="student_ids" name="student_ids" />
												</div>

										</div>
									</div>

								</div>
					</div>

	            	
	            </div>
			</div>
			 <div class="clearfix"></div>
	         <div class="card-box mt-20">
               	<div class="col-md-12 col-sm-12 col-xs-12 border-top mt-20 ptb-10 text-center">
               		<input type="button" onclick="submitDataClose()" name="save_close" id="save_close" value="រក្សាទុក" label="<?php echo $tr->translate('SAVE_CLOSE');?>"  dojoType="dijit.form.Button" 
					   class="button-class button-primary" iconClass="glyphicon glyphicon-floppy-saved" />
					 <input type="submit" name="save_new" id="save_new" value="រក្សាទុក" label="<?php echo $tr->translate('SAVE_NEW');?>"  dojoType="dijit.form.Button" 
					 class="button-class button-primary" iconClass="glyphicon glyphicon-floppy-open" />
               	</div>
             </div>
		</form>
    	
    </div>
</div>
<script src="<?php echo $this->baseUrl();?>/js/help.js"  type="text/javascript"></script>
<script type="text/javascript">
	dojo.require("dojo.data.ItemFileWriteStore");  
	dojo.require("dojo.NodeList-manipulate");
	dojo.require('dijit.form.NumberTextBox');
	dojo.require("dijit.form.DateTextBox");
	
	//var pro_store  = getDataStorefromJSON('id','name', <?php print_r(Zend_Json::encode($this->product));?> );
	
	var branch_store  = getDataStorefromJSON('id','name', <?php print_r(Zend_Json::encode($this->branchopt));?> );
	dojo.ready(function(){ 
		getStudentByBranch();
		new dijit.form.FilteringSelect({
			store: stu_store,
			queryExpr: "*${0}*",
			autoComplete: false,                     
			required: true,                      
			id: "stu_id",
			name: "stu_id",  
			class: 'fullside',  
			required:false,
			placeHolder:"<?php echo $tr->translate("SELECT_PRODUCT");?>",          
			onChange: function() {  
				stu_id   = dijit.byId('stu_id').get('value');
				branch_id= dijit.byId('branch').get('value');
				if(stu_id==-1 || stu_id==''){
					if(stu_id==-1){
						window.open('<?php echo Zend_Controller_Front::getInstance()->getBaseUrl()."/stock/product/add";?>','_blank');
						}
					 return false;
				}else{
					var rowId = $('#identity').val();
	    			if(rowId!=''){ 
						var rowIDArray = rowId.split(',');
						for(var n = 0; n < rowIDArray.length; n++){
						var product_name = dijit.byId('product_name_'+rowIDArray[n]).get('value');
						var location_id = dijit.byId('branch_id_'+rowIDArray[n]).get('value');
						if(product_name == stu_id && branch_id==location_id){
							var num=dijit.byId("request_qty"+rowIDArray[n]).get("value");
							var curr_qty=dijit.byId("curr_qty"+rowIDArray[n]).get("value");
							  if(isNaN(num)){
								  num=0;
							  }
							  if(curr_qty<=num){
								  dijit.byId("request_qty"+rowIDArray[n]).attr("value",curr_qty);
								  return false;
							  }
                            dijit.byId("request_qty"+rowIDArray[n]).attr("value",parseFloat(num)+1);
                            getCurrQty(rowIDArray[n]);
							return false;
							}
						}
					}
					addRow();
				}
			}
		}, "stu_id");
	});	
</script>
<script type="text/javascript">
dojo.ready(function(){
	
	 var branch_id = dijit.byId('branch');
	 branch_id.on('change', function(evt) {
		 dojo.query("#table_row").append("");
		 $("#identity").val("");
    });
});	

var template = '';
var product_name = '';
var col = 0;
var no = 0;
var title = 0;
tmp = '';
temp='';
function addRow() {
	label_stuname = dijit.byId("stu_id").attr('displayedValue');
	stu_id=dijit.byId("stu_id").get("value");
	branch_id=dijit.byId("branch").get("value");
		col++;no++;
		template='';
		if(title!=1){
			temp+='<th><?php echo $tr->translate("DEL");?></th>';
			temp+='<th><?php echo $tr->translate("N_O");?></th>';
			temp+='<th id="lbl_titlemetion" width="100px"><?php echo $tr->translate("STUDENT_NAME");?></th>';
			temp+='<th id="lbl_titlemetion" width="100px"><?php echo $tr->translate("គណិត");?></th>';
			temp+='<th id="lbl_titlemetion" width="100px"><?php echo $tr->translate("ភាសាខ្មែរ");?></th>';
			temp+='<th id="lbl_titlemetion" width="100px"><?php echo $tr->translate("រូបវិទ្យា");?></th>';
			temp+='<th id="lbl_titlemetion" width="100px"><?php echo $tr->translate("គីមីវិទ្យា");?></th>';
			temp+='<th id="lbl_titlemetion" width="100px"><?php echo $tr->translate("ជីវៈវិទ្យា");?></th>';
			temp+='<th id="lbl_titlemetion" width="100px"><?php echo $tr->translate("អង់គ្លេស");?></th>';
			temp+='<th id="lbl_titlemetion" width="100px"><?php echo $tr->translate("ពិន្ទុសរុប");?></th>';
			temp+='<th id="lbl_titlemetion" width="100px"><?php echo $tr->translate("មធ្យមភាគ");?></th>';
			temp+='<th id="lbl_titlemetion" width="100px"><?php echo $tr->translate("RANK");?></th>';
			dojo.query("#head-title").append(temp);
			title=1;
		}
			template+='<td width="47px" align="center">	<i onclick="deleteRecord('+col+')" class="glyphicon glyphicon-trash" aria-hidden="true"></i></td>';
			template+='<td width="15px" align="center"  >'+no+'<input type="hidden" dojoType="dijit.form.TextBox" required="true" id="branch_id_'+col+'" name="branch_id_'+col+'" value="'+branch_id+'" /></td>';
			template+='<td width="20%">&nbsp;'+label_stuname+'<input type="hidden" dojoType="dijit.form.TextBox" required="true" id="product_name_'+col+'" name="product_name_'+col+'" value="'+stu_id+'" /></td>';
			template+='<td width="100px"><input type="text" required="true" name="math'+col+'" id="math'+col+'" dojoType="dijit.form.NumberTextBox" style="width:100%;"/></td>';
			template+='<td width="100px"><input type="text" required="true" name="khmer'+col+'" id="khmer'+col+'" onkeyup="getCurrQty('+col+');" dojoType="dijit.form.NumberTextBox" style="width:100%;" /></td>';
			template+='<td width="100px"><input type="text" required="true"  name="physic'+col+'" id="physic'+col+'" dojoType="dijit.form.NumberTextBox" style="width:100%;"  /></td>';
			template+='<td ><input type="text" required="true" name="chemistry'+col+'" id="chemistry'+col+'" dojoType="dijit.form.TextBox" style="width:100%;" /></td>';
			template+='<td ><input type="text" required="true"  name="biology'+col+'" id="biology'+col+'" dojoType="dijit.form.TextBox" style="width:100%;" /></td>';
			template+='<td ><input type="text"  required="true" name="english'+col+'" id="english'+col+'" dojoType="dijit.form.TextBox" style="width:100%;" /></td>';
			template+='<td ><input type="text"   name="total'+col+'" id="total'+col+'" dojoType="dijit.form.TextBox" style="width:100%;"  readonly="true"/></td>';
			template+='<td ><input type="text"   name="everage'+col+'" id="everage'+col+'" dojoType="dijit.form.TextBox" style="width:100%;" readonly="true" /></td>';
			template+='<td ><input type="text"  name="rank'+col+'" id="rank'+col+'" dojoType="dijit.form.TextBox" style="width:100%;" readonly="true" /></td>';
		tmp='<tr align="center" id="row'+col+'">';
		tmp+="</tr>";
		dojo.query("#table_row").append(tmp);

		if($("#identity").val()!="") {
			var identity = $("#identity").val();
			$("#identity").val(identity+','+col);
		} else {$("#identity").val(col);}

		
		if($("#student_ids").val()!="") {
			var stuIds = $("#student_ids").val();
			$("#student_ids").val(stuIds+','+stu_id);
		} else {$("#student_ids").val(stu_id);}

		dojo.html.set(dojo.byId("row"+col),template , {
		     parseContent: true,
		});
		getQtyById(col);
 }
function deleteRecord(index) {

		var identity = $('#identity').val();
		var arrays = identity.split(',');

		
		var stuIds = $('#student_ids').val();
		var stu_arrays = stuIds.split(',');

		for(var i=0;i<arrays.length;i++) {
			if(arrays[i] == index) {
				arrays.splice(i,1);

				stu_arrays.splice(i,1);
				
			}
		}
		var strings = arrays.join(',');
		var strings_student = stu_arrays.join(',');
		$('#identity').val(strings);
		$('#student_ids').val(strings_student);
		dojo.query("#row"+index).remove();
		
}


var stu_store  = getDataStorefromJSON('id','name', <?php print_r(array())?> );
var url_student_branch= '<?php echo $this->url(array('module'=>'foundation','controller'=>'test','action'=>'get-pro-bylocation')); ?>';
function getStudentByBranch(){
	    branch_id=dijit.byId("branch").get("value");
	    if(branch_id=='' || branch_id==-1){
		    alert("Please Selected Branch Name!");
		    return false ;
	    }
		dojo.xhrPost({
			url:url_student_branch,
			content:{
				'branch_id':branch_id
				},
			handleAs:"json",
			load: function(data) {
				dijit.byId('stu_id').set('value','');
				stu_store  = getDataStorefromJSON('id','name', data);
			    dijit.byId('stu_id').set('store',stu_store); 
			    document.getElementsByClassName("overlay")[0].style.display="none";
				
			},
			error: function(err) {
			   
			}
		});
}
function getCurrQty(r){
	curr_qty=dijit.byId("curr_qty"+r).get("value");
	request_qty=dijit.byId("request_qty"+r).get("value");
	var spacing_qty=parseFloat(curr_qty-request_qty);
	dijit.byId("spacing_qty"+r).attr("value",spacing_qty);
}
</script>