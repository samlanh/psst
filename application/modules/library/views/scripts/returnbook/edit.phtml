<?php
$tr = Application_Form_FrmLanguages::getCurrentlanguage();
echo $this->headTitle($tr->translate("EDIT_RETURN_BOOK"));
echo $this->headTitle();
$frm = $this->frm_callteral;
$frm = $this->frm_loan;
$tr = Application_Form_FrmLanguages::getCurrentlanguage();
$baseurl =  Zend_Controller_Front::getInstance()->getBaseUrl();
//print_r($this->rs_return);
 
?>
<style>
	.fullside50{ width:48%;}
</style>
<div class="overlay">
	<div class="overlay-load">
		<div class="overlay-msg">
		</div>
	</div>
</div>
<style>
.dojoxGridSortNode{
		text-align: center;	
		height: 30px;
	}
.dijitTabPaneWrapper , .dijitContentPane,.dijitTabListContainer-top{max-width: 99% !important;}	
</style>
<script src="<?php echo $baseurl;?>/js/help.js"></script>
<script type="text/javascript"  src="<?php echo $this->baseUrl();?>/js/jquery-1.7.2.min.js"></script>
<script>
	dojo.require("dijit.layout.TabContainer");
	dojo.require("dijit.form.Textarea");
	dojo.require("dijit.Dialog");
	require(["dijit/form/DateTextBox","dijit/form/NumberTextBox","dojo/number","dijit/Dialog"]);

	dojo.ready(function(){
		 
		setValue();
	    //oldAdd();
		dijit.byId("stu_id").attr("value","<?php echo $this->rs_return['stu_id'];?>");
		dijit.byId("stu_id").attr("value","<?php echo $this->rs_return['borrow_id']?>");
		getAllcustomer('<?php echo $this->rs_return['id']?>');
	});
		
</script>
<form id='frm_add_tran' action="" dojoType="dijit.form.Form" method="post" enctype="application/x-www-form-urlencoded">
 
	<table width="100%" style="padding-top: 10px;">
	<tr>
		<td>
				<fieldset style="margin-top:-13px;">
					<legend align="center" ><strong style="font-size: 18px;"><?php echo $tr->translate("EDIT_RETURN_BOOK");?></strong></legend>
					<table style="margin: 0 auto; width: 100%;" cellspacing="10" >
						<tr>
							<td nowrap="nowrap"><?php echo $tr->translate("STUDENT_ID")?></td>
							<td>
								<select name="stu_id" id="stu_id" dojoType="dijit.form.FilteringSelect" onchange="setValue(); "  readonly="true" >
								       <option value="0"><?php echo $tr->translate("SELECT_STUDENT_ID")?></option>
								 <?php if(!empty($this->stu_id)) foreach($this->stu_id As $rs_id){?>
										<option value="<?php echo $rs_id['stu_id']?>" ><?php echo $rs_id['stu_code'];?></option>
								 <?php }?>
								</select>
							</td>
							<td nowrap="nowrap"><?php echo $tr->translate("STUDENT_NAME")?></td>
							<td>
								<select   name="stu_name" id="stu_name" dojoType="dijit.form.FilteringSelect" placeholder="Select Degree" onchange="setValue();" readonly="true"  >
									<option value="0"><?php echo $tr->translate("SELECT_STUDENT_NAME")?></option>
									<?php 
									if(!empty($this->stu_name))foreach ($this->stu_name as $row){?>
										<option value="<?php echo $row['stu_id']?>"><?php echo $row['name']?></option>
									<?php }?>
								</select>
							</td>
							<td nowrap="nowrap"><?php echo $tr->translate("IS_TYPE")?></td>
							<td ><input dojoType="dijit.form.TextBox" id="is_type" name="is_type" type="text"  value="" readonly="true">  </td>
						</tr>
						<tr>
							<td nowrap="nowrap"><?php echo $tr->translate("RETURN_NO")?></td>
							<td style="font-weight: 600;"><input dojoType="dijit.form.TextBox"   name="return_no" id="return_no" value="<?php echo $this->rs_return['return_no']?>"  type="text" readonly="readonly" ></td>
							<td style="width: 5px;white-space: nowrap;"><?php echo $tr->translate("RETURN_DATE")?></td>
							<td><input dojoType="dijit.form.DateTextBox" id="return_date" name="return_date" type="text" constraints="{datePattern:'dd/MM/yyyy'}"  value="<?php echo $this->rs_return['return_date']?>" ></td>
							<td ><?php echo $tr->translate("STATUS")?></td>
							<td><select name="status" id="status" dojoType="dijit.form.FilteringSelect">
								    <option value="1" <?php if($this->rs_return['status']==1) echo 'selected="selected"';?>><?php echo $tr->translate("ACTIVE")?></option>
								     <option value="0" <?php if($this->rs_return['status']==0) echo 'selected="selected"';?>><?php echo $tr->translate("DEACTIVE")?></option>
								</select>
							</td>
						</tr>
						<tr>
						   <td><?php echo $tr->translate("PHONE")?></td>
						   <td><input dojoType="dijit.form.TextBox"   name="phone" id="phone" value="<?php echo $this->rs_return['phone']?>"  type="text" ></td>
						    <td><?php echo $tr->translate("NOTE")?></td>
							<td colspan="4">
								<textarea id="notes" rows="2" cols="82" name="notes" dojoType="dijit.form.Textarea" style="height:35px;"><?php echo $this->rs_return['note']?></textarea>								
							</td>
						</tr>
						<tr>
							<td colspan="8">
							<input type="hidden"  id="record_row" name="record_row" value="0"  dojoType="dijit.form.TextBox" />
								<input type="hidden"  id="record_row1" name="record_row1" value=""  dojoType="dijit.form.TextBox" />
							 <div  id="showrecord"></div>
							</td>
						</tr>
						<tr>
							<td colspan="6" align="center">
								<input iconClass="dijitIconClear" type="reset" value="សំអាត" label="<?php echo $tr->translate('CLEAR');?>" dojoType="dijit.form.Button"/>
									<input type="submit" value="save_close" name="save_close" label="<?php echo $tr->translate('SAVE_CLOSE');?>" dojoType="dijit.form.Button" 
										iconClass="dijitEditorIcon dijitEditorIconSave" />
							</td>
						</tr>
					</table>
				</fieldset>
		</td>
	</tr>
</table>
</form>
<script>
dojo.require("dojo.data.ItemFileWriteStore");
dojo.require("dojo.NodeList-manipulate");
dojo.require("dojo.html");

r=0;
function myYmd(D){
	var pad = function(num) {
		var s = '0' + num;
		return s.substr(s.length - 2);
	}
	var Result = D.getFullYear() + '-' + pad((D.getMonth() + 1)) + '-' + pad(D.getDate());
	return Result;
}

url_getvillagecode = '<?php echo $this->url(array('module'=>'library','controller'=>'returnbook','action'=>'get-return-book-detail'));?>';
function getAllcustomer(id){
	temp='';
	stu_id  = dijit.byId('stu_id').get('value');
	fund_title=0;
	dojo.query("#showrecord").append('');
	tmp='<table id="t_amountmoneytype" width="100%" style=" margin-top: 20px; border-collapse: collapse; border:1px solid #ccc !important;">';
	tmp+='<tr style="background:#eee; font-size: 14px; height: 40px;font-weight: bold; margin-bottom: 10px;" id="head_title" class="head-title" align="center"></tr>';
	tmp+='</table>';
	dojo.query("#showrecord").append(tmp);
	
	dojo.xhrPost({
		url: url_getvillagecode,
		content:{
			'stu_id':stu_id,
			'id':id
		},
		handleAs:"json",
		load: function(data) {
			dijit.byId('record_row').attr('value','');
			if(data==''){
				alert('Student can not item !');
				thead='<th style="margin-bottom: 20px;"><?php echo $tr->translate("DEL");?></th>';
				thead+='<th style="width:10px;"><?php echo $tr->translate("N_O");?></th>';
				thead+='<th ><?php echo $tr->translate("RETURN_NO");?></th>';
				thead+='<th ><?php echo $tr->translate("BOOK_NO");?></th>';
				thead+='<th ><?php echo $tr->translate("BOOK_TITLE");?></th>';
				thead+='<th ><?php echo $tr->translate("BORROW_QTY");?></th>';
				thead+='<th><?php echo $tr->translate("RETURN_QTY");?></th>';
				thead+='<th style="width:60px;"><?php echo $tr->translate("CHECKED");?>&nbsp;</th>';
				thead+='<th style="width:100px;"><?php echo $tr->translate("RETURN_DATE");?></th>';
				thead+='<th style="width:100px;"><?php echo $tr->translate("NOTE");?></th>';
				fund_title=1;
				dojo.query("#head_title").append(thead);
			}
		
			for(i=0;i<data.length;i++){
				r++;
				if(fund_title!=1){
					thead='<th style="margin-bottom: 20px;"><?php echo $tr->translate("DEL");?></th>';
					thead+='<th style="width:10px;"><?php echo $tr->translate("N_O");?></th>';
					thead+='<th ><?php echo $tr->translate("RETURN_NO");?></th>';
					thead+='<th ><?php echo $tr->translate("BOOK_TITLE");?></th>';
					thead+='<th ><?php echo $tr->translate("BORROW_QTY");?></th>';
					thead+='<th><?php echo $tr->translate("RETURN_QTY");?></th>';
					thead+='<th style="width:60px;"><?php echo $tr->translate("CHECKED");?>&nbsp;</th>';
					thead+='<th style="width:100px;"><?php echo $tr->translate("DELAY_QTY");?></th>';
					thead+='<th style="width:100px;"><?php echo $tr->translate("RETURN_DAY");?></th>';
					thead+='<th style="width:100px;"><?php echo $tr->translate("DATE_DELAY");?></th>';
					thead+='<th style="width:100px;"><?php echo $tr->translate("NOTE");?></th>';
					fund_title=1;
					dojo.query("#head_title").append(thead);
					dijit.byId('is_type').attr('value',data[i].borrow_type);
				}
				//ccc=data[i].paid;
				ccc=0;
				if(ccc==0){
					//	dijit.byId("check"+r).checked=true;
					check="checked='checked'";
				}else {
					check='';
				}
				temp='<td  ><img style="cursor:pointer" onclick="deleteRecord('+r+')" src="<?php echo $this->baseUrl();?>/images/Delete_16.png"></td>';
				temp+='<td>'+r+'</td>';
				temp+='<td>'+data[i].return_no+'<input  type="hidden" value="'+data[i].return_id+'"  name="borrow_id_'+r+'"  id="borrow_id_'+r+'"  /> <input  type="hidden" value="'+data[i].borrow_id+'"  name="oldborrow_id'+r+'"  id="oldborrow_id'+r+'"  /></td>';
				temp+='<td>'+data[i].book_name+"("+data[i].book_no+")"+'<input  type="hidden"   value="'+data[i].book_id+'"  name="book_id_'+r+'"  id="book_id_'+r+'"  dojoType="dijit.form.TextBox"/></td>';
				temp+='<td>'+data[i].borr_qty+' ក្បាល<input  type="hidden"   value="'+data[i].borr_qty+'" required   name="oldqty_return_'+r+'"  id="oldqty_return_'+r+'"  /><input  type="hidden"   value="'+data[i].oldbor_qty+'" required   name="oldbor_qty_'+r+'"  id="oldbor_qty_'+r+'"  /></td>';
				
				temp+='<td><input  style="margin-left:0px;width:100px;font-weight:900; "  type="text" data-dojo-props="constraints:{places:0}" value="'+data[i].borr_qty+'"    name="return_qty_'+r+'"  id="return_qty_'+r+'" dojoType="dijit.form.NumberTextBox"   onkeyup="compareValue('+r+');getQtyReurtn('+r+')" /><input  type="hidden" value="'+data[i].borr_qty+'"  name="old_return_qty'+r+'"  id="old_return_qty'+r+'" dojoType="dijit.form.TextBox"   /></td>';
				temp+='<td style="width: 20px"><input value="'+r+'" style="width: 20px;" onchange="uncheck('+r+')" type="checkbox"  name="check'+r+'" id="check'+r+'" '+check+'   /></td>';

				temp+='<td><input  style="margin-left:0px;width:50px;font-weight:900; "  type="text" data-dojo-props="constraints:{places:0}" value="'+data[i].delay_qty+'" name="delay_qty_'+r+'"  id="delay_qty_'+r+'" dojoType="dijit.form.NumberTextBox" readonly="true" onkeyup="getQtyDelay('+r+');"/><input  type="hidden" value="'+data[i].delay_qty+'"  name="old_delay_qty_'+r+'"  id="old_delay_qty_'+r+'" dojoType="dijit.form.TextBox"   /></td>';
				
				temp+='<td>'+setDate(data[i].return_date)+'<input  style="margin-left:0px;width:200px; "  type="hidden" data-dojo-props="constraints:{places:0}" value="'+data[i].return_date+'"    name="date_return_'+r+'"  id="date_return_'+r+'" dojoType="dijit.form.TextBox" /></td>';
				temp+='<td><input  style="margin-left:0px;width:150px; "  type="text"   value="'+data[i].date_delay+'" constraints='+'{datePattern:"dd/MM/yyyy"}'+'   name="date_delay_'+r+'"  id="date_delay_'+r+'" dojoType="dijit.form.DateTextBox" readonly="true"/></td>';
				temp+='<td><input  style="margin-left:0px;width:200px; "  type="text" data-dojo-props="constraints:{places:0}" value=""    name="note_'+r+'"  id="note_'+r+'" dojoType="dijit.form.TextBox" /></td>';
				tmp='<tr style="border:1px solid #deafaf; font-size:14px;height:37px; !important;text-align:center;" id="row_capital'+r+'" >'
				tmp+="</tr>";
				dojo.query("#t_amountmoneytype").append(tmp);
				dojo.html.set(dojo.byId("row_capital"+r),temp, {
					parseContent: true,
				});
				if(dijit.byId("record_row").get('value')!="") {
					var ids = dijit.byId("record_row").get("value");
					dijit.byId("record_row").attr('value',ids+','+r);
				}
				else { dijit.byId("record_row").attr('value',r);
				}
			}
		},error: function(err) {
		}
	});
}

function checkSelect(r) {
		var a = $("input:checked").val();
		var identity_arr = [];
		$(':checkbox:checked').each(function(i){
			identity_arr[i] = $(this).val();
		});
		dijit.byId("record_row1").attr('value',identity_arr);
}

function uncheck(r) {
   if($("#check"+r).is(":checked")){
	   dijit.byId("return_qty_"+r).set('readOnly',true);
	   dijit.byId("delay_qty_"+r).set('readOnly',true);
	   dijit.byId("date_delay_"+r).set('readOnly',true);
	   //dijit.byId("delay_qty_"+r).set('value',0);
   }else{
	   dijit.byId("return_qty_"+r).set('readOnly',false);
	   dijit.byId("delay_qty_"+r).set('readOnly',false);
	   dijit.byId("date_delay_"+r).set('readOnly',false);
   }
}
 
function deleteRecord(index) {
	var identity = $('#record_row').val();
	var arrays = identity.split(',');
	for(var i=0;i<arrays.length;i++) {
		if(arrays[i] == index) arrays.splice(i,1);
	}
	var strings = arrays.join(',');
	$('#record_row').val(strings);
	$("#row_capital"+index).remove();

	if (arrays.length<=0){
		dijit.byId("save_close").attr('disabled',true);
		dijit.byId("save_new").attr('disabled',true);
	}
	netTotal();
}

function disableSave() {
	alert("ការបញ្ជូលជោគជ័យ !");
}

function setDate(d){
	 d=new Date(d);
	 var yyyy = d.getFullYear().toString();
	 var mm = (d.getMonth() + 101).toString().slice(-2);
	 var dd = (d.getDate() + 100).toString().slice(-2);
	 return dd+'/'+ mm +'/'+yyyy;
}

function setValue(){
	stu_id=dijit.byId("stu_id").get("value");
	if(stu_id!='' || stu_id !=0){
		dijit.byId("stu_name").attr("value",stu_id);
	}
}

function compareValue(r){
	return_qty=dijit.byId("return_qty_"+r).get("value");
	borrow_qty=$("#oldbor_qty_"+r).val();
	oldqty_return=$("#oldqty_return_"+r).val();
	var total = parseInt(borrow_qty) + parseInt(oldqty_return) ;
	if( return_qty > total){
		alert('Quantity return​ can not bigger then borrow qty​ !');
		dijit.byId("return_qty_"+r).attr("value",total);
	}
}

function getQtyDelay(r){
	delay_qty=dijit.byId("delay_qty_"+r).get('value');
	return_qty=dijit.byId("return_qty_"+r).get('value');
	old_qty=dijit.byId("old_return_qty"+r).get('value');
	old_delay_qty=dijit.byId("old_delay_qty_"+r).get('value');
	all_qty=parseInt(old_delay_qty)+parseInt(old_qty);
	total=all_qty-delay_qty;
	
	dijit.byId('return_qty_'+r).attr('value',total);
	//alert(all_qty);
	if(delay_qty > all_qty ){
		 alert("Delay qty can't bigger return qty !");
		dijit.byId("delay_qty_"+r).attr('value',all_qty);
		dijit.byId("return_qty_"+r).attr('value',0);
		 
	}
}

function getQtyReurtn(r){
	delay_qty=dijit.byId("delay_qty_"+r).get('value');
	return_qty=dijit.byId("return_qty_"+r).get('value');
	old_qty=dijit.byId("old_return_qty"+r).get('value');
	old_delay_qty=dijit.byId("old_delay_qty_"+r).get('value');
	all_qty=parseInt(old_delay_qty)+parseInt(old_qty);
	total=all_qty-return_qty;
	dijit.byId('delay_qty_'+r).attr('value',total);
	if(delay_qty > all_qty ){
		alert("Delay qty can't bigger return qty !");
		dijit.byId("delay_qty_"+r).attr('value',all_qty);
		dijit.byId("return_qty_"+r).attr('value',0);
	}
}

</script>
