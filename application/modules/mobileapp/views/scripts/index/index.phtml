<?php
	$tr = Application_Form_FrmLanguages::getCurrentlanguage();
	echo $this->headTitle($tr->translate('MOBILE_APP_DASHBOARD'));
	$countingDownloaded = $this->countingDownloaded;
	$countingUser = $this->countingUser;
?>
<div class="card pb-10 pt-10 pl-10 pr-10">
	<div class="card-content collapse show">
		<div class="card-box">
               	<div class="col-sm-12 border-botom">
		    		<div class="col-sm-8 pd-0">
		    			<h4 class="m-b-0"><i class="fa fa-graduation-cap" aria-hidden="true"></i>&nbsp;&nbsp;&nbsp;<?php echo $tr->translate('MOBILE_APP_DASHBOARD');?></h4>
	    			</div>
	    			<div class="col-sm-4 text-right">
	    			</div>
	    		</div>
	    </div>
		<div class="card-box">
			<div class="row">
				<div class="col-lg-5 col-md-5 col-sm-5 col-xs-12">
					<div class="row tile_count">
						<div class="col-md-4 col-sm-4 col-xs-12 tile_stats_count">
						  <span class="count_top"><i class="fa fa-download"></i> <?php echo $tr->translate('totalDownloaded');?></span>
						  <div class="count"><?php echo empty($countingDownloaded["totalDownloaded"]) ? "00" : sprintf('%02d',$countingDownloaded["totalDownloaded"]); ?></div>
						  
						</div>
						<div class="col-md-4 col-sm-4 col-xs-12 tile_stats_count">
						  <span class="count_top"><i class="fa fa-calendar-check-o"></i> <?php echo $tr->translate('totalDownloadThisMonth');?></span>
						  <div class="count"><?php echo empty($countingDownloaded["totalDownloadThisMonth"]) ? "00" : sprintf('%02d',$countingDownloaded["totalDownloadThisMonth"]); ?></div>
						  
						</div>
						<div class="col-md-4 col-sm-4 col-xs-12 tile_stats_count">
						  <span class="count_top"><i class="fa fa-download"></i> <?php echo $tr->translate('totalDownloadToday');?></span>
						  <div class="count green"><?php echo empty($countingDownloaded["totalDownloadToday"]) ? "00" : sprintf('%02d',$countingDownloaded["totalDownloadToday"]); ?></div>
						</div>
				  </div>
					<div class="x_panel well">
						<div class="x_title">
						  <h2><i class="fa fa-laptop"></i>&nbsp;<?php echo $tr->translate("Device Usage");?></h2>
						  <div class="clearfix"></div>
						</div>
						<div class="x_content">
							<table class="" style="width:100%">
								<tbody>
									<tr>
										<th style="width:50%;">
											
										</th>
										<th>
											<div class="col-lg-7 col-md-7 col-sm-7 col-xs-12">
												<p class=""><?php echo $tr->translate("DEVICE");?></p>
											</div>
											<div class="col-lg-5 col-md-5 col-sm-5 col-xs-12">
												<p class=""><?php echo $tr->translate("DOWNLOADED");?></p>
											</div>
										</th>
									</tr>
									<tr>
										<td>
											<div id="donutSummary" class="morris-donut-inverse" style="width:100%; height:185px;"></div>
										</td>
										<td>
											<table class="tile_info">
												<tbody>
													<?php if(!empty($this->summaryDevice)) foreach($this->summaryDevice AS $device){ ?>
													<tr>
														<td>
														  <p><i class="fa fa-square " style="color:<?php echo empty($device["color"]) ? "blue" : $device["color"]; ?>;" ></i><?php echo $device["label"];?> </p>
														</td>
														<td style=" text-align: right;"><?php echo empty($device["value"]) ? "00" : sprintf('%02d',$device["value"]); ?></td>
													</tr>
													<?php } ?>
												</tbody>
											</table>
										</td>
									</tr>
								</tbody>
							</table>
							<table class="" style="width:100%">
								<tbody>
									<tr>
										<th style="width:50%;">
											
										</th>
										<th>
											<div class="col-lg-12 col-md-12 col-sm-7 col-xs-12">
												<p class=""><?php echo $tr->translate("USER_ACCOUNT");?></p>
											</div>
										</th>
									</tr>
									<tr>
										<td>
											<div id="donutSummaryAccount" class="morris-donut-inverse" style="width:100%; height:185px;"></div>
										</td>
										<td>
											<table class="tile_info">
												<tbody>
													<?php if(!empty($this->summaryAccount)) foreach($this->summaryAccount AS $device){ ?>
													<tr>
														<td>
														  <p><i class="fa fa-square " style="color:<?php echo empty($device["color"]) ? "blue" : $device["color"]; ?>;" ></i><?php echo $device["label"];?> </p>
														</td>
														<td style=" text-align: right;"><?php echo empty($device["value"]) ? "00" : sprintf('%02d',$device["value"]); ?></td>
													</tr>
													<?php } ?>
												</tbody>
											</table>
										</td>
									</tr>
								</tbody>
							</table>
							
						</div>
					</div>
				</div>
				<div class="col-lg-7 col-md-7 col-sm-7 col-xs-12">
					<div class="x_panel">
						<div class="x_title">
							<h2><i class="fa fa-graduation-cap"></i>&nbsp;<?php echo $tr->translate("Last Active");?><small></small></h2>
							<div class="clearfix"></div>
						</div>
						<div class="x_content">
							<div class="" role="tabpanel" data-example-id="togglable-tabs">
								  <ul id="myTab" class="nav nav-tabs bar_tabs" role="tablist">
									<li role="presentation" class="active">
										<a href="#tabContent1" id="home-tab" role="tab" data-toggle="tab" aria-expanded="true"><?php echo $tr->translate("STUDENTS_DEVICE");?></a>
									</li>
									<li role="presentation" class="">
										<a href="#tabContent3" role="tab" id="profile-tab" data-toggle="tab" aria-expanded="false"><?php echo $tr->translate("TEACHER_DEVICE");?></a>
									</li>
								  </ul>
								  <div id="myTabContent" class="tab-content">
									<div role="tabpanel" class="tab-pane fade active in" id="tabContent1" aria-labelledby="home-tab">
										<div class="row">
											<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 text-right">
											  <a  href="<?php echo $this->baseUrl()."/mobileapp/index/list?recordtype=1";?>" class="btn btn-primary btn-sm">
												<i class="fa fa-hand-o-right"> </i> <?php echo $tr->translate("SHOW_ALL");?>
											  </a>
											</div>
										</div>
										<table id="datatable-responsive"  class="display nowrap dataTable dtr-inline collapsed" cellspacing="0" width="100%">
											<thead>
												<tr>
													<th><?php echo $tr->translate("NUM");?></th>
													<th style="width: 15%"><?php echo $tr->translate("accountInfo");?></th>
													<th style="width: 15%"><?php echo $tr->translate("STUDY_INFO");?></th>
													<th><?php echo $tr->translate("DEVICE");?></th>
													<th><?php echo $tr->translate("ACTION");?></th>
												</tr>
											</thead>
											<tbody>
											<?php 
											$i=0;
											if(!empty($this->deviceRs)) foreach($this->deviceRs as $rs){ 
												$i++;
												$tokenType = $rs["tokenType"];
											?>
												<tr>
													<td align="center"><?php echo $i;?></td>
													<td>
														<small id="userCode<?php echo $tokenType.$i;?>"><?php echo $rs["userCode"];?></small><br />
														<small id="userName<?php echo $tokenType.$i;?>" class="title"><?php echo $rs["userNameInKh"]; echo empty($rs["userNameInEn"])? "":" / ".$rs["userNameInEn"];?></small><br />
													</td>
													<td>
														<small id="userDegreeTitle<?php echo $tokenType.$i;?>"><?php echo $rs["degreeTitle"];?></small><br />
														<span id="userGroupCode<?php echo $tokenType.$i;?>" class="title"><?php echo $rs["groupCode"]; ?></span><br />
													</td>
													<td>
														<span id="userDevice<?php echo $tokenType.$i;?>"><i class="fa fa-tablet" ></i> <?php echo $rs["device_model_name"];?></span><br />
														<small id="lastActive<?php echo $tokenType.$i;?>" class="text-success" title="<?php echo $tr->translate("Last Active");?>"><i class="fa fa-clock-o" ></i> <?php echo date("d-M-Y H:i:s",$rs["last_active"]);?></small><br />
													</td>
													<td>
														<input type="hidden" value="<?php echo $rs["userId"]; ?>" name="userId<?php echo $tokenType.$i;?>" id="userId<?php echo $tokenType.$i;?>" dojoType="dijit.form.TextBox" />
														<a href="javascript:void(0)" onClick="showChangePassword(<?php echo $i;?>,<?php echo $tokenType;?>);" title="<?php echo $tr->translate("CHANGE_PASSWORD");?>"><i class="fa fa-key" ></i></a>
													</td>
												</tr>
											<?php } ?>
											</tbody>
										</table>
									</div>
									<div role="tabpanel" class="tab-pane fade" id="tabContent3" aria-labelledby="home-tab">
										<div class="row">
											<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 text-right">
											  <a  href="<?php echo $this->baseUrl()."/mobileapp/index/list?recordtype=3";?>" class="btn btn-primary btn-sm">
												<i class="fa fa-hand-o-right"> </i> <?php echo $tr->translate("SHOW_ALL");?>
											  </a>
											</div>
										</div>
										<table  id="" class="datatable-responsive display nowrap dataTable dtr-inline collapsed" cellspacing="0" width="100%">
											<thead>
												<tr>
													<th><?php echo $tr->translate("NUM");?></th>
													<th style="width: 25%"><?php echo $tr->translate("accountInfo");?></th>
													<th><?php echo $tr->translate("DEVICE");?></th>
													<th><?php echo $tr->translate("ACTION");?></th>
												</tr>
											</thead>
											<tbody>
											<?php 
											$i=0;
											if(!empty($this->teacherDevice)) foreach($this->teacherDevice as $rs){ 
												$i++;
												$tokenType = $rs["tokenType"];
											?>
												<tr>
													<td align="center"><?php echo $i;?></td>
													<td>
														<small id="userCode<?php echo $tokenType.$i;?>"><?php echo $rs["userCode"];?></small><br />
														<small id="userName<?php echo $tokenType.$i;?>" class="title"><?php echo $rs["userNameInKh"]; echo empty($rs["userNameInEn"])? "":" / ".$rs["userNameInEn"];?></small><br />
													</td>
													<td>
														<span id="userDevice<?php echo $tokenType.$i;?>"><i class="fa fa-tablet" ></i> <?php echo $rs["device_model_name"];?></span><br />
														<small id="lastActive<?php echo $tokenType.$i;?>" class="text-success" title="<?php echo $tr->translate("Last Active");?>"><i class="fa fa-clock-o" ></i> <?php echo date("d-M-Y H:i:s",$rs["last_active"]);?></small><br />
													</td>
													<td>
														<input type="hidden" value="<?php echo $rs["userId"]; ?>" name="userId<?php echo $tokenType.$i;?>" id="userId<?php echo $tokenType.$i;?>" dojoType="dijit.form.TextBox" />
														<a href="javascript:void(0)" onClick="showChangePassword(<?php echo $i;?>,<?php echo $tokenType;?>);" title="<?php echo $tr->translate("CHANGE_PASSWORD");?>"><i class="fa fa-key" ></i></a>
													</td>
												</tr>
											<?php } ?>
											</tbody>
										</table>
									</div>
							  </div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<style>
.ptss-frame.js-ptss-frame {
    display: none !important;
}
table.tile_info {
    padding: 10px 15px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
</style>
<div class="dijitHidden">
	<div data-dojo-type="dijit.Dialog" id="popupChangePassword" data-dojo-props="title:'<?php echo $tr->translate("CHANNGE_PASSWORD"); ?>'">
		<form  id='frmChangePassword' name='frmChangePassword' dojoType="dijit.form.Form" method="post" enctype="application/x-www-form-urlencoded">
			 <div class="card">
				<div class="card-content collapse show">
					<div class="card-box">
						<div class="left col-md-12 col-sm-12 col-xs-12">
                              <h2 id="userCode">Nicole Pearson</h2>
                              <h2 id="userName">Nicole Pearson</h2>
                              <p id="userDevice"><strong>About: </strong> Web Designer / UX / Graphic Artist / Coffee Lover </p>
						</div>
					</div>
					<div class="card-box">
						<div class="row">
							<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
								<div class="form-group">
								   <label class="control-label  col-md-5 col-sm-5 col-xs-12" ><?php echo $tr->translate("PASSWORD");?></label>
								   <div class="col-md-7 col-sm-7 col-xs-12">
										<input class='fullside' type="password" required="true" name="password" id="password" placeholder="<?php echo $tr->translate("PASSWORD");?>" regExp="\w{6,}" invalidMessage="ពាក្យសំងាត់យ៉ាងតិច មាន 6 តួអក្សរ" dojoType="dijit.form.ValidationTextBox" />
								   </div>
								</div>
								<div class="form-group">
								   <label class="control-label  col-md-5 col-sm-5 col-xs-12" ><?php echo $tr->translate("CONFIRM_PASSWORD");?></label>
								   <div class="col-md-7 col-sm-7 col-xs-12">
										<input type="hidden" value="0" name="userId" id="userId" dojoType="dijit.form.TextBox" />
										<input type="hidden" value="0" name="deviceTokenType" id="deviceTokenType" dojoType="dijit.form.TextBox" />
										<input class='fullside' type="password" required="true" name="con_password" id="con_password" placeholder="<?php echo $tr->translate("CONFIRM_PASSWORD");?>" regExp="\w{6,}" invalidMessage="ពាក្យសំងាត់យ៉ាងតិច មាន 6 តួអក្សរ" dojoType="dijit.form.ValidationTextBox" />
								   </div>
								</div>
							</div>
						</div>
					</div>
					<div class="clearfix"></div>
				    <div class="card-box">
		               	<div class="col-md-12 col-sm-12 col-xs-12 border-top mt-20 ptb-10 text-center">
							<input type="button" class="button-class button-primary"  iconClass="glyphicon glyphicon-repeat" value="<?php echo $tr->translate('SAVE');?>" label="<?php echo $tr->translate('SAVE');?>"  dojoType="dijit.form.Button" onClick="goChangePassword();" />
			    		</div>
			    	</div>
				</div>
			</div>
		</form>
	</div>
</div>

<link rel="stylesheet" href="<?php echo $this->baseUrl()."/"?>dashboard/plugins/morris/morris.css">
<script src="<?php echo $this->baseUrl()."/"?>dashboard/plugins/morris/morris.min.js"></script>
<script type="text/javascript">
dojo.ready(function(){
	 $('div svg text').css({
		"font-family" : "inherit !important",
		"padding" : "3%"
	});
});

var colorDanger = "#FF1744";
Morris.Donut({
  element: 'donutSummary',
  resize: true,
  data: <?php  echo Zend_Json::encode($this->summaryDevice);?>
});


Morris.Donut({
  element: 'donutSummaryAccount',
  resize: true,
  data: <?php  echo Zend_Json::encode($this->summaryAccount);?>
});


function showChangePassword(rowKey,tokenType){
		dijit.byId('deviceTokenType').set('value', tokenType);
		dijit.byId('userId').set('value', dijit.byId("userId"+tokenType+rowKey).get('value'));
		dojo.byId("userCode").innerHTML = dojo.byId("userCode"+tokenType+rowKey).innerHTML;
		dojo.byId("userName").innerHTML = dojo.byId("userName"+tokenType+rowKey).innerHTML;
		dojo.byId("userDevice").innerHTML = dojo.byId("userDevice"+tokenType+rowKey).innerHTML +' '+ dojo.byId("lastActive"+tokenType+rowKey).innerHTML;
		dijit.byId("popupChangePassword").show();
	}
	var voidReciept = '<?php echo $this->url(array('module'=>'mobileapp','controller'=>'index','action'=>'change-password')); ?>';
	function goChangePassword(){
		
		if(dojo.byId('password').value != dojo.byId('con_password').value ){
				alert('<?php echo $tr->translate("passwordAndConfirmPasswordNotMatch");?>');
				dojo.byId('password').value = '';
				dojo.byId('con_password').value = '';
				dijit.byId('password').focus();
				return false;
			}
		if(dijit.byId('frmChangePassword').validate()){
			if(confirm("<?php echo $tr->translate("Do you want to change password");?>")){
		}else{
			dijit.byId('frmChangePassword').reset();
			dijit.byId('popupChangePassword').hide();
			return false;
		}
			
			loadingBlock();
			dojo.xhrPost({
				url: voidReciept,
				form: dojo.byId("frmChangePassword"),
				handleAs:"json",
				load: function(data){
					dijit.byId('frmChangePassword').reset();
					dijit.byId('popupChangePassword').hide();
					if(data==1){
						alert("<?php echo $tr->translate("CHANGE_PASSWORD_SUCCESS");?>");
					}else{
						alert("<?php echo $tr->translate("CHANGE_PASSWORD_FAIL");?>");
					}
					location.reload();
					HideloadingBlock();
				},
				error: function(err){
					dijit.byId('frmChangePassword').reset();
					dijit.byId('popupChangePassword').hide();
					HideloadingBlock();
				}
			});
		}
	}

</script>