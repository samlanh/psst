<?php
	$tr = Application_Form_FrmLanguages::getCurrentlanguage();
	echo $this->headTitle($tr->translate('INITILIZE_USE')); 
	$frm= $this->frm_discount;
	$baseurl =  Zend_Controller_Front::getInstance()->getBaseUrl();
	$baseurl =  Zend_Controller_Front::getInstance()->getBaseUrl();
	$photo = $this->baseUrl() . "/images/no-profile.png";
?>
<style>
.font-size{font-size: 12px;}
</style>
<div class="card">
	<div class="card-content collapse show">
		<div class="card-box">
               	<div class="col-sm-12 border-botom">
		    		<div class="col-sm-8 pd-0">
		    			<h4 class="m-b-0"><i class="fa fa-shield " aria-hidden="true"></i>&nbsp;&nbsp;&nbsp;<?php echo $tr->translate('INITILIZE_USE');?></h4>
    			</div>
    			<div class="col-sm-4 text-right">
    			</div>
    		</div>
    	</div>
		<form id='add_discount' action="" method="post" dojoType="dijit.form.Form" enctype="application/x-www-form-urlencoded">
			<script type="dojo/method" event="onSubmit"> 
					branch=dijit.byId('branch_id').get('value');
					if(branch==''){
						alert('Please Select Branch!');
						dijit.byId('branch_id').focus()
						return false;
					}
					var identity = $('#identity').val();
					if(identity==''){
						alert("There is no record to save");
						dijit.byId("itemId").focus();
						return false;
					}
  					if(this.validate()){
    					dijit.byId("save_close").attr("disabled",true);
						dijit.byId("save_new").attr("disabled",true);
   						 return true;
   					}else{
    					return false;
   					}
			</script>
			<div class="row">
				<div class="col-md-4 col-sm-4 col-xs-12">
					<div class="card-body"> 
						<div class="row"> 
							<div class="col-md-12 col-sm-12 col-xs-12"> 
								<div class="d-flex"> 
									<div class="settings-main-icon ">
										<i class="glyphicon glyphicon-user"></i>
									</div> 
									<div class="col-md-10 col-sm-10 col-xs-12"> 
										<p class="tx-20 font-weight-semibold d-flex "><?php echo $tr->translate("STUDENT_INFO");?></p>
									</div> 
								</div>
								<div class="form-group">
									<label class="control-label bold col-md-5 col-sm-5 col-xs-12"><?php echo $tr->translate("BRANCH");?> <span class="required">*</span></label>
									<div class="col-md-7 col-sm-7 col-xs-12">
										<?php echo $frm->getElement("branch_id");?>
										<input type="hidden" name="inFrame" id="inFrame" value="<?php echo $this->inFrame;?>"  dojoType="dijit.form.TextBox" class='fullside'/>
									</div>
								 </div>
								 <div class="form-group">
									<label class="control-label bold col-md-5 col-sm-5 col-xs-12" ><?php echo $tr->translate("STUDENT_NAME");?>
								   </label>
								   <div class="col-md-7 col-sm-7 col-xs-12">
										<input id="studentId" />
									</div>
								 </div>
								 <div class="form-group">
								   <label class="control-label  col-md-5 col-sm-5 col-xs-12" ><?php echo $tr->translate("ACADEMIC_YEAR");?> :
								   </label>
								   <div class="col-md-7 col-sm-7 col-xs-12">
										<input id="study_year" />
								   </div>
								 </div>
							</div>
						</div>
					</div>
             	</div>
				<div class="col-md-4 col-sm-4 col-xs-12">
					<div class="card-body"> 
						<div class="row"> 
							<div class="col-md-12 col-sm-12 col-xs-12"> 
								<div class="d-flex"> 
									<div class="settings-main-icon ">
										<i class="glyphicon glyphicon-user"></i>
									</div> 
									<div class="col-md-10 col-sm-10 col-xs-12"> 
										<p class="tx-20 font-weight-semibold d-flex "><?php echo $tr->translate("STUDENT_INFO");?></p>
									</div> 
								</div>
								<div id="lbl_blog" class="row g-3">
								
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="row">
             	<div class="col-md-12 col-sm-12 col-xs-12">
					<div class="card card-form mb-4">
						<div class="card-body">
							<div class="row" style="background: #d8e0e2; padding: 15px 15px; margin: 0; border: solid 1px #697996; border-radius: 2px;">
							   <div class="col-md-4 col-sm-4 col-xs-12">
									<div class="row g-3">
											<label class="control-label bold col-md-3 col-sm-3 col-xs-12" ><?php echo $tr->translate("TYPE");?>
									   </label>
									   <div class="col-md-9 col-sm-9 col-xs-12">
											<input id="itemType" />
										</div>
									 </div>
							   </div>
							   <div class="col-md-7 col-sm-7 col-xs-12">
									<div class="row g-3">
									  <div class="row g-3">
										<label class="control-label bold col-md-5 col-sm-5 col-xs-12" ><?php echo $tr->translate("COURSE_SERVICE_PRODUCT").'/'.$tr->translate("PRODUCT");?>
									   </label>
									   <div class="col-md-7 col-sm-7 col-xs-12">
											<input id="itemId" />
											<input type="hidden" id="identity"  name="identity"/>
										</div>
									 </div>
								   </div>
							   </div>
							   <div class="col-md-1 col-sm-1 col-xs-12"></div>
							</div>
							<div class="row g-3">
								<table class="collape responsiveTable" border="1" style="border-collapse: collapse; width:100%; border:1px solid #ccc;">
									<thead>
										<tr id="head-title" class="head-td" align="right" style="width: 100%;">
											<th width="47px"><?php echo $tr->translate("DEL");?></th>
											<th width="50px"><?php echo $tr->translate("N_O");?></th>
											<th width="200px"><?php echo $tr->translate("DESCRIPTION");?></th>
											
											<th><?php echo $tr->translate("VALIDATE");?></th>
											<th width="200px"><?php echo $tr->translate("BALANCE");?></th>
											<th width="200px"><?php echo $tr->translate("REMARK");?></th>
										</tr>
									</thead>
									<tbody id="table_row">
									</tbody>
								</table>
							</div>
						</div>
					</div>
				</div>
           </div>
			<div class="clearfix"></div>
	        <div class="row">
					<div class="col-md-12 col-sm-12 col-xs-12 border-top mt-20 ptb-10 text-center">
	               	<input type="submit"  value="save_close" name="save_close" id="save_close" label="<?php echo $tr->translate('SAVE_CLOSE');?>" dojoType="dijit.form.Button" 
						class="button-class button-primary" iconClass="glyphicon glyphicon-floppy-remove" />
					<input type="submit" value="save_new" name="save_new" id="save_new" label="<?php echo $tr->translate('SAVE_NEW');?>" dojoType="dijit.form.Button" 
						 class="button-class button-primary" iconClass="glyphicon glyphicon-floppy-disk" />
               	</div>
               </div>
		</form>
	</div>
</div>
<div id="emptyStudent" class="d-none">
	<div class="p-0 mt-0">
		<div class="row">
			<div class="col-md-4 col-sm-4 col-xs-12">
				<div class="customer-avatar-section">
				  <div class="d-flex align-items-center flex-column px-2">
					<img class="img-fluid border rounded mb-2" src="<?php echo $photo; ?>" height="130px" width="92px" alt="User avatar">
					<div class="customer-info text-center mb-2">
					</div>
				  </div>
				</div>
			</div>
			<div class="col-md-8 col-sm-8 col-xs-12">
				<div class="info-container">
					<h4 class="text-primary mb-0 m-0"></h4>
					<h4 class="text-primary mb-0 m-0"></h4>
					<h6 class="mb-0"></h6>
					<ul class="list-unstyled mb-2 recordMoreInfo">
						<li class="mb-0">
						  <small class=" me-1">
						  <?php echo $tr->translate("GRADE"); ?> :
						  </small>
						  <small class="stu-info"></small>
						</li>
						<li class="mb-0">
						  <small class=" me-1">
						  <?php echo $tr->translate("GROUP_CODE"); ?> :
						  </small>
						  <small class="stu-info"></small>
						</li>
					</ul>
					<div class="border-top mt-10 mb-10 "></div>
					<ul class="list-unstyled mb-2 recordMoreInfo">
						<li class="mb-0">
						  <small class=" me-1">
						 <?php echo $tr->translate("DOB"); ?> :
						  </small>
						  <small class="stu-info"></small>
						</li>
						<li class="mb-0">
						  <small class=" me-1">
						  <?php echo $tr->translate("PHONE"); ?> :
						  </small>
						  <small class="stu-info"></small>
						</li>
						<li class="mb-0">
						  <small class=" me-1">
						  <?php echo $tr->translate("Year Enrolled"); ?> :
						  </small>
						  <small class="stu-info"></small>
						</li>
						<li class="mb-0">
						  <small class=" me-1">
						   <?php echo $tr->translate("STUDENT_TYPE"); ?> :
						  </small>
						  <small class="stu-info"></small>
						</li>
					</ul>
				</div>
			</div>
		</div>
	</div>
</div>
<style>
	
tr.head-td th {
	padding: 5px 2px;
}

#lbl_blog span {
	line-height: 25px;
	font-size: 14px;
}
	
.removePadding .col-md-6, .removePadding .col-sm-6, .removePadding .col-xs-12 {
    padding-right: 2px;
    padding-left: 2px;
}
.fullwidth {
    width: 100% !important;
}
#table_row td {
    vertical-align: top;
    padding: 8px 2px;
}
</style>
<script src="<?php echo $this->baseUrl();?>/admin/js/global.js"  type="text/javascript"></script>
<script src="<?php echo $baseurl;?>/js/help.js"></script>
<script>
	dojo.require("dojo.data.ItemFileWriteStore");
	dojo.require("dijit.form.DateTextBox");
	dojo.require("dijit.form.Textarea");
	 dojo.require("dojo.NodeList-manipulate");
	 dojo.require("dijit.form.NumberTextBox");
	var ItemTypestore  = getDataStorefromJSON('id','name', <?php print_r(Zend_Json::encode($this->itemType));?> );
	dojo.ready(function(){


	new dijit.form.FilteringSelect({
		queryExpr: "*${0}*",
		autoComplete: false,                     
		required: true,                     
		id: "study_year",
		name: "study_year",
		class: "fullside", 		
		placeHolder:"<?php echo $tr->translate("SELECT_ACADEMIC_YEAR");?>",          
		onChange: function() { 
			 
		}
	}, "study_year");
		
	new dijit.form.FilteringSelect({
		store:ItemTypestore,
		required: false,  
		autoComplete: false,
		queryExpr: "*${0}*",                      
	    id: "itemType",
	    name: "itemType",  
	    tabindex: "1",         
	    class: 'fullside',  
	    placeHolder:"<?php echo $tr->translate("SELECT_CATEGORY")?>", 
	    onChange: function() {          
	    	dijit.byId("itemId").reset();
	    	getAllItemId();
	   }
	}, "itemType");

	new dijit.form.FilteringSelect({
		required: false,  
		autoComplete: false,
		queryExpr: "*${0}*",                      
	    id: "itemId",
	    name: "itemId",  
	    tabindex: "1",         
	    class: 'fullside',  
	    placeHolder:"<?php echo $tr->translate("SELECT_ITEM")?>", 
	    onChange: function() {   
	    	addRow();       
	   }
	}, "itemId");

	new dijit.form.FilteringSelect({
		required: true,  
		autoComplete: false,
		queryExpr: "*${0}*",                      
	    id: "studentId",
	    name: "studentId",  
	    tabindex: "1",         
	    class: 'fullside',  
	    placeHolder:"<?php echo $tr->translate("SELECT_STUDENT_NAME")?>", 
		onChange:function(){
			getStudentInfo();
		}
	   
	    
	}, "studentId");

	branchId = dijit.byId('branch_id');
	branchId.on('change',function(evt){
		branchId = dijit.byId('branch_id').get('value');
		
		dijit.byId("studentId").reset();
		dijit.byId("study_year").reset();
		dijit.byId("itemId").reset();
		
		$(".offcanvas-title").html('<i class="ti ti-school ti-sm ms-n1 me-2"></i><?php echo $tr->translate("STUDENT_INFO"); ?>');
		var emptyStudent = $("#emptyStudent").html();
		$("#lbl_blog").html(emptyStudent);
		var contentInfo = $("#emptyInfo").html();
		$(".offcanvas-content").html(contentInfo);
	
		if(branchId==''){
			dijit.byId("branch_id").focus();
			return false;
		}
		getAllstudentBranch();
		getAllAcademicBy();
		getAllItemId();
	});
	getAllstudentBranch();
	getAllAcademicBy();
	getAllItemId();
	
	<?php if(!empty($this->studentRow)){?>
	dijit.byId('branch_id').attr('value','<?php echo $this->studentRow["branch_id"]; ?>');
	setTimeout(function () {
			dijit.byId('studentId').attr('value','<?php echo $this->studentRow["stu_id"]; ?>');
	}, 600);
	<?php }?>
	
});

function getAllstudentBranch(){
	
	$(".offcanvas-title").html('<i class="ti ti-school ti-sm ms-n1 me-2"></i><?php echo $tr->translate("STUDENT_INFO"); ?>');
	var emptyStudent = $("#emptyStudent").html();
	$("#lbl_blog").html(emptyStudent);
	var contentInfo = $("#emptyInfo").html();
	$(".offcanvas-content").html(contentInfo);
		
	dijit.byId("studentId").reset();
	branchId = dijit.byId('branch_id').get('value');
	if(branchId==''){
		 dijit.byId('branch_id').focus();
		 return false;
	}
	var urlGet = '<?php echo $this->url(array('module'=>'registrar','controller'=>'register','action'=>'getliststudenturl')); ?>';
	
	contentData = {
			'branchId':branchId,
			'customerType':1,
			'joinGroup':1,
			'activeStudent':1,
			'isCurrent':1,
			'is_maingrade':1,
			}
	getAllStudentByBranch(urlGet,contentData);
}
function getAllAcademicBy(){
	dijit.byId("study_year").reset();
	branchId = dijit.byId('branch_id').get('value');
	if(branchId==''){
		 dijit.byId('branch_id').focus();
	}
	
	url_getacademic = '<?php echo $this->url(array('module'=>'accounting','controller'=>'fee','action'=>'getfeeid'));?>';
	contentData = {
		'branch_id':branchId,
		'isFinished':0
	}
	getAllAcademicByBranch(url_getacademic,contentData);
}
function getAllItemId(itemId=''){
	dijit.byId("itemId").reset();
	branchId = dijit.byId('branch_id').get('value');
	studentId = dijit.byId('studentId').get('value');
	itemType = dijit.byId('itemType').get('value');
	var urlGet = '<?php echo $this->url(array('module'=>'global','controller'=>'grade','action'=>'get-allitemid')); ?>';
	if(branchId==''){
		return false;
	}
	contentData = {
		'proLocation':branchId,
		'itemId':itemType,
		'studentId':studentId,
		'hiddenParent':1,
		'itemsTypeList':"2,3",
		'isOnepayment':0,
	}
	getAllItemIdByType(urlGet,contentData);
}

var template = '';
var col = 0;
var no = 0;
var title = 0;
tmp = '';
temp='';
var discountOptionList="";
function addRow(rowData=""){ 
		startDate = "<?php echo date("Y-m-d",strtotime("-1 month"))?>";
		endDate = "<?php echo date("Y-m-d")?>";
		deleteBtn="";
		rowRemark="";
		serviceBalance=0;
		discountType=0;
		discountAmount=0;
		detailId=0;
		rowFeeId=0;
		if(rowData!=""){
			col++;no++;
			itemId = rowData.grade;
			label_itemId = rowData.itemTitle;
			startDate = rowData.startDate;
			endDate = rowData.endDate;
			serviceBalance = rowData.balance;
			discountType = rowData.discountType;
			discountAmount = rowData.discountAmount;
			detailId = rowData.detailId;
			rowFeeId = rowData.feeId;
			rowRemark = rowData.note;
		}else{
			label_itemId = dijit.byId("itemId").attr('displayedValue');
			itemId=dijit.byId("itemId").get("value");
			if(itemId==''){return false;}
			var iden = $("#identity").val();
			var arrays = iden.split(',');
			 if(arrays!=""){
				 for(var i=0;i< arrays.length;i++) {
					 readychoose = dijit.byId('itemId_'+arrays[i]).get('value');
					 if(readychoose==itemId){
							alert("<?php echo $tr->translate("Choosen ready")?>");
							return false;
					 }
				}
			}
			col++;no++;
			deleteBtn='<img onclick="deleteRecord('+col+')" src="<?php echo $this->baseUrl();?>/images/Delete_16.png">';
		}
		
		
		template='';
		strCol6 = '<div class="col-md-6 col-sm-6 col-xs-12 m-0">';
		if(title!=1){
			$("#head-title").html("");    
			temp+='<th width="47px"><?php echo $tr->translate("DEL");?></th>';
			temp+='<th width="50px"><?php echo $tr->translate("N_O");?></th>';
			temp+='<th width="200px"><?php echo $tr->translate("DESCRIPTION");?></th>';
			temp+='<th><?php echo $tr->translate("VALIDATE");?></th>';
			temp+='<th width="200px"><?php echo $tr->translate("BALANCE");?></th>';
			temp+='<th width="200px"><?php echo $tr->translate("REMARK");?></th>';
			dojo.query("#head-title").append(temp);
			title=1;
		}
		
		
		
			template+='<td align="center">'+deleteBtn+'</td>';
			template+='<td  align="center">'+no+'</td>';
			template+='<td class="font-size">';
				template+=label_itemId;
				template+='<input type="hidden" dojoType="dijit.form.TextBox" required="true" id="itemId_'+col+'" name="itemId_'+col+'" value="'+itemId+'" />';
				template+='<input type="hidden" dojoType="dijit.form.TextBox" required="true" id="detailId'+col+'" name="detailId'+col+'" value="'+detailId+'" />';
				template+='<input type="hidden" dojoType="dijit.form.TextBox" required="true" id="rowFeeId'+col+'" name="rowFeeId'+col+'" value="'+rowFeeId+'" />';
			template+='</td>';
			
		
			
			
			template +='<td>';
				template +='<div class="row g-3">';
					template += strCol6 + '<input type="text" value="'+startDate+'" placeHolder="<?php echo $tr->translate('START_DATE'); ?>" class="fullside" constraints=' + '{datePattern:"dd/MM/yyyy"}' + ' name="date_start_'+col+'" id="date_start_'+col+'" dojoType="dijit.form.DateTextBox" /></div>';
					template += strCol6 + '<input type="text" value="'+endDate+'" placeHolder="<?php echo $tr->translate('END_DATE'); ?>" class="fullside" constraints=' + '{datePattern:"dd/MM/yyyy"}' + ' name="end_date_'+col+'" id="end_date_'+col+'" dojoType="dijit.form.DateTextBox" /></div>';
				template +='</div>';
			template +='</td>';
			template+='<td ><input type="text" value="'+serviceBalance+'" name="balance_'+col+'" class="fullside" id="balance_'+col+'" dojoType="dijit.form.NumberTextBox" placeholder="<?php echo $tr->translate('BALANCE'); ?>"/></td>';
			
			
			template+='<td ><input type="text" value="'+rowRemark+'"  name="remark'+col+'" class="fullside" id="remark'+col+'" dojoType="dijit.form.Textarea" placeholder="Remark" style="min-height:35px;" /></td>';
		tmp='<tr id="row'+col+'" class="hover">';
		tmp+="</tr>";
		dojo.query("#table_row").append(tmp);

		if($("#identity").val()!="") {
			var identity = $("#identity").val();
			$("#identity").val(identity+','+col);
		} else {$("#identity").val(col);}
		dojo.html.set(dojo.byId("row"+col),template , {
		     parseContent: true,
		});
		
 }
function deleteRecord(index){
	var identity = $('#identity').val();
	var arrays = identity.split(',');
	for(var i=0;i<arrays.length;i++) {
	if(arrays[i] == index) arrays.splice(i,1);
	}
	var strings = arrays.join(',');
	$('#identity').val(strings);
	dojo.query("#row"+index).remove();
}


function getStudentInfo() {
	
	dojo.query("#table_row").append("");
	$("#identity").val("");
	var url_getdata = '<?php echo $this->url(array('module' => 'registrar', 'controller' => 'initilizeuse', 'action' => 'getstudentinfo')); ?>';
	discountOptionList="";
	studentId = dijit.byId('studentId').get('value');
	if (studentId == '') { return false; }
	dojo.xhrPost({
		url: url_getdata,
		content: {
			'studentId': studentId,
		},
		handleAs: "json",
		load: function (data) {
			if (data) {
				$("#lbl_blog").html(data.contentHtmlStudyInfo);
				discountOptionList  = data.disOption;
				studentData = data.studentData;
				var studentFeeId = (studentData.fee_id=="") ? 0 : studentData.fee_id;
				
				if(studentFeeId>0){
					dijit.byId("study_year").set('value', studentFeeId);
				}
				if(data.contentHtml!=""){
					$(".offcanvas-content").html(data.contentHtml);
				}
				
				for (eRow = 0; eRow < (data.currentService).length; eRow++) {
					var thisRow = data.currentService[eRow];
					console.log(data.currentService[eRow]);
					addRow(thisRow);
				}
			}
		},
		error: function (err) {
		}
	});
}
</script>