<?php
	$tr = Application_Form_FrmLanguages::getCurrentlanguage();
	echo $this->headTitle($tr->translate("PHOTO_MG"));
	$blankImage = $this->baseUrl().'/images/no-profile.png';
	$frm = $this->frm;
?>	
<div class="card pb-10 pt-10 pl-10 pr-10">
	<div class="card-content collapse show">
		<div class="card-box">
               	<div class="col-sm-12 border-botom">
		    		<div class="col-sm-8 pd-0">
		    			<h4 class="m-b-0"><i class="glyphicon glyphicon-modal-window" aria-hidden="true"></i>&nbsp;&nbsp;&nbsp;<?php echo $tr->translate('PHOTO_MG');?></h4>
    			</div>
    			<div class="col-sm-4 text-right">
    			</div>
    		</div>
    	</div>
		<form id='frmUploadPhoto' action="" dojoType="dijit.form.Form" method="post" enctype="multipart/form-data">
			<script type="dojo/method" event="onSubmit">
				   if(this.validate()) {
					
					branchId = dijit.byId('branchId').get('value');
					if(branchId==-1 || branchId=="" ){
						 dijit.byId("branchId").focus();
						return false;
					}
					var recordId = $('#recordId').find(":selected").val();
					if(recordId=="" || recordId==0 ){
						$('#recordId').select2('open');
						return false;
					}
					
					loadingBlock();
					return true;
				   }else {
					return false;
				   }
			</script>
			
		<div class="card-box">
			<div class="col-md-4 col-sm-4 col-xs-12">
				<div class="card-blogform">
					<div class="card-body"> 
						<div class="form-group">
							<div class="d-flex"> 
								<div class="settings-main-icon ">
									<i class="glyphicon glyphicon-user" aria-hidden="true"></i>
								</div> 
								<div class="col-md-10 col-sm-10 col-xs-12"> 
									<p class="tx-20 font-weight-semibold d-flex "><?php echo $tr->translate("INFORMATION");?></p>
								</div> 
							</div>
						</div>
						<div class="form-group">
							<label class="control-label bold  col-md-5 col-sm-5 col-xs-12" ><?php echo $tr->translate("BRANCH");?> <span class="required">*</span></label>
							<div class="col-md-7 col-sm-7 col-xs-12">
								<?php echo $frm->getElement("branchId");?>
							</div>
						 </div>
						<div class="form-group">
							<label class="control-label bold  col-md-5 col-sm-5 col-xs-12" ><?php echo $tr->translate("RECORD_TYPE");?><span class="required">*</span></label>
							<div class="col-md-7 col-sm-7 col-xs-12">
								<?php echo $frm->getElement("recordType");?>
							</div>
						 </div>
						<div class="form-group">
							<label class="control-label bold  col-md-5 col-sm-5 col-xs-12" ><?php echo $tr->translate("PHOTO_STATUS");?><span class="required">*</span></label>
							<div class="col-md-7 col-sm-7 col-xs-12">
								<?php echo $frm->getElement("photoStatus");?>
							</div>
						</div>
						<div class="form-group">
						   <label id="recordInfo" class="control-label  col-md-5 col-sm-5 col-xs-12" >
						   <?php echo $tr->translate("STUDENT");?>
						   </label>
						   <div class="col-md-7 col-sm-7 col-xs-12">
								<select class="custome-select-opt fullside" placeHolder="<?php echo $tr->translate("SELECT_RECORD"); ?>" required="false" name="recordId" id="recordId" ></select>
						   </div>
						</div>
						
						<input type="hidden" class="form-control" id="recordCode" name="recordCode" placeholder="x">
						<input type="hidden" class="form-control" id="baseFileUpload" name="baseFileUpload" placeholder="x">
					</div>
				</div>
				<div class="col-md-12 col-sm-12 col-xs-12 profile_details">
                        <div class="well profile_view">
                          <div class="col-sm-12">
                            <h4 class="brief"><i class="recordNo">000000</i></h4>
                            <div class="left col-xs-7">
                              <h2 class="recordNameKh">N/A</h2>
                              <h2 class="recordNameEng">N/A</h2>
                              <ul class="list-unstyled recordMoreInfo">
                                <li><i class="fa fa-graduation-cap"></i> ឆ្នាំសិក្សា N/A</li>
								<li><i class="fa fa-building"></i> ថ្នាក់/ក្រុម N/A</li>
								<li><i class="fa fa-phone"></i> លេខទូរសព្ទ </li>
                              </ul>
                            </div>
                            <div class="right col-xs-5 text-center">
                              <img src="<?php echo $blankImage;?>" alt="" class="record-img img-circle img-responsive">
                            </div>
                          </div>
                          <div class="col-xs-12 bottom text-center">
                            <div class="col-xs-12 col-sm-6 emphasis">
                              
                            </div>
                            <div class="col-xs-12 col-sm-6 emphasis">
                             
                            </div>
                          </div>
                        </div>
                      </div>
			</div>
			<div class="col-md-8 col-sm-8 col-xs-12">
				<div class="container">
					<div class="row">
					  <div class="col-md-9">
						<!-- <h3>Demo:</h3> -->
						<div class="img-container">
						  <img id="image" src="<?php echo $this->baseUrl()."/images/no-profile.png" ?>" alt="Picture">
						</div>
					  </div>
					  <div class="col-md-3">
						<div class="docs-preview clearfix">
						  <div class="img-preview preview-lg"></div>
						</div>
							<div class="docs-data">
								<div class="input-group input-group-sm">
									<label class="input-group-addon" for="dataWidth">Width</label>
									<input type="text" class="form-control" id="dataWidth" placeholder="width" value="275">
									<span class="input-group-addon">px</span>
								  </div>
								<div class="input-group input-group-sm">
									<label class="input-group-addon" for="dataHeight">Height</label>
									<input type="text" class="form-control" id="dataHeight" placeholder="height" value="345">
									<span class="input-group-addon">px</span>
								</div>
								  
								<div class="disableControl">
									  <div class="input-group input-group-sm">
										<label class="input-group-addon" for="dataX">X</label>
										<input type="text" class="form-control" id="dataX" placeholder="x">
										<span class="input-group-addon">px</span>
									  </div>
									  <div class="input-group input-group-sm">
										<label class="input-group-addon" for="dataY">Y</label>
										<input type="text" class="form-control" id="dataY" placeholder="y">
										<span class="input-group-addon">px</span>
									  </div>
									 
									  <div class="input-group input-group-sm">
										<label class="input-group-addon" for="dataRotate">Rotate</label>
										<input type="text" class="form-control" id="dataRotate" placeholder="rotate">
										<span class="input-group-addon">deg</span>
									  </div>
									  <div class="input-group input-group-sm">
										<label class="input-group-addon" for="dataScaleX">ScaleX</label>
										<input type="text" class="form-control" id="dataScaleX" placeholder="scaleX">
									  </div>
									  <div class="input-group input-group-sm">
										<label class="input-group-addon" for="dataScaleY">ScaleY</label>
										<input type="text" class="form-control" id="dataScaleY" placeholder="scaleY">
									  </div>
								</div>
							</div>
							<div class="docs-buttons">
								<div class="row pb-10">
									<div class="col-md-6 col-sm-6 col-xs-12">
										<div class="btn-group">
										  <button type="button" class="btn btn-primary" data-method="zoom" data-option="0.1" title="<?php echo $tr->translate('Zoom In');?>">
											<span class="docs-tooltip" title="<?php echo $tr->translate('Zoom In');?>">
											  <span class="fa fa-search-plus"></span>
											</span>
										  </button>
										  <button type="button" class="btn btn-primary" data-method="zoom" data-option="-0.1" title="<?php echo $tr->translate('Zoom Out');?>">
											<span class="docs-tooltip" title="<?php echo $tr->translate('Zoom Out');?>">
											  <span class="fa fa-search-minus"></span>
											</span>
										  </button>
										</div>
									</div>
									<div class="col-md-6 col-sm-6 col-xs-12">
										<div class="btn-group">
										  <button type="button" class="btn btn-primary" data-method="rotate" data-option="-45" title="<?php echo $tr->translate('Rotate Left');?>">
											<span class="docs-tooltip" title="<?php echo $tr->translate('Rotate Left');?>">
											  <span class="fa fa-rotate-left"></span>
											</span>
										  </button>
										  <button type="button" class="btn btn-primary" data-method="rotate" data-option="45" title="<?php echo $tr->translate('Rotate Right');?>">
											<span class="docs-tooltip" title="<?php echo $tr->translate('Rotate Right');?>">
											  <span class="fa fa-rotate-right"></span>
											</span>
										  </button>
										</div>
									</div>
								</div>
								<div class="row pb-10">
									<div class="col-md-6 col-sm-6 col-xs-12 ">
										<div class="btn-group">
										  <button type="button" class="btn btn-primary" data-method="scaleX" data-option="-1" title="<?php echo $tr->translate('Flip Horizontal');?>">
											<span class="docs-tooltip" title="<?php echo $tr->translate('Flip Horizontal');?>">
											  <span class="fa fa-arrows-h"></span>
											</span>
										  </button>
										  <button type="button" class="btn btn-primary" data-method="scaleY" data-option="-1" title="<?php echo $tr->translate('Flip Vertical');?>">
											<span class="docs-tooltip"  title="<?php echo $tr->translate('Flip Vertical');?>">
											  <span class="fa fa-arrows-v"></span>
											</span>
										  </button>
										</div>
									</div>
										
									<div class="col-md-6 col-sm-6 col-xs-12 ">
										<div class="btn-group">
										  <button type="button" class="btn btn-primary" data-method="reset" title="<?php echo $tr->translate('Reset');?>">
											<span class="docs-tooltip" title="<?php echo $tr->translate('Reset');?>">
											  <span class="fa fa-refresh"></span>
											</span>
										  </button>
										  <label class="btn btn-success btn-upload" for="inputImage" title="Upload image file">
											<input type="file" class="sr-only" id="inputImage" name="fileName" accept=".jpg,.jpeg,.png,.gif,.bmp,.tiff">
											<span class="docs-tooltip" title="<?php echo $tr->translate('Choose Image');?>">
											  <span class="fa fa-upload"></span> 
											</span>
										  </label>
										</div>
									</div>
								</div>
								<div class="row ">
									<div class="col-md-12 col-sm-12 col-xs-12 border-top mt-20 ptb-10 text-center">
										<div class="btn-group btn-group-crop">
										  <button type="button" class="btn btn-primary" data-method="getCroppedCanvas">
											<span class="docs-tooltip"  >
											  <span class="fa fa-floppy-o"></span> <?php echo $tr->translate("SAVE");?>
											</span>
										  </button>
										</div>
									</div>
								</div>
							</div>
					  </div>
					</div>
					<div class="row">
					  

					</div>
				  </div>
			</div>
		</div>
		</form>
	</div>
</div>
<style>
.ptss-frame.js-ptss-frame ,
.disableControl{
	display:none;
}
</style>

<script src="<?php echo $this->baseUrl();?>/js/help.js"  type="text/javascript"></script>

<link href="<?php echo $this->baseUrl()."/admin"?>/3.5.0/select2.css" rel="stylesheet">
<script src="<?php echo $this->baseUrl()."/admin"?>/3.5.0/select2.min.js"></script>
<script> 
$(document).ready(function() {
	$("#recordId").select2(
		{dropdownAutoWidth : true,allowClear: "true"}
	);	
	
	$('#recordId').on('change', function(){
	   getRecordInfo();
	});
	
	
	$("#crop").click(function() {
		
		var currentWith = parseInt($('#dataWidth').val());
		var currentHeight = parseInt($('#dataHeight').val());
	
        canvas = cropper.getCroppedCanvas({
            width: currentWith,
            height: currentHeight,
        });

        canvas.toBlob(function(blob) {
            url = URL.createObjectURL(blob);
            var reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = function() {
                var base64data = reader.result;
				//alert(base64data);
                /*$.ajax({
                    type: "POST",
                    dataType: "json",
                    url: "crop_image_upload.php",
                    data: {image: base64data},
                    success: function(data) { 
                        bs_modal.modal('hide');
                        alert("success upload image");
                    }
                });*/
            };
        });
    });
	
});
dojo.ready(function(){
	var branchId = dijit.byId('branchId');
	 branchId.on('change', function(evt) {
		 getRecordOption();
	});
	var recordType = dijit.byId('recordType');
	 recordType.on('change', function(evt) {
		 getRecordOption();
	});
	
	var photoStatus = dijit.byId('photoStatus');
	 photoStatus.on('change', function(evt) {
		 getRecordOption();
	});
	
	
	getRecordOption();	
});	
var blankImage = "<?php echo $blankImage; ?>";
var strBlank="";
strBlank+='<li><i class="fa fa-graduation-cap"></i> <?php echo $tr->translate("ACADEMIC_YEAR"); ?> N/A</li>';
strBlank+='<li><i class="fa fa-building"></i> <?php echo $tr->translate("GROUP_CODE"); ?> N/A</li>';
strBlank+='<li><i class="fa fa-phone"></i> <?php echo $tr->translate("TEL"); ?> </li>';
								
function getRecordInfo(){
	$('.record-img').attr('src', blankImage);
	$('.recordNo').html("N/A");
	$('.recordNameKh').html("N/A");
	$('.recordNameEng').html("N/A");
	$('.recordMoreInfo').html(strBlank);  
	var recordId = $('#recordId').find(":selected").val();
	if(typeof recordId !=="undefined" ){
		if( recordId >0){
			var recordInfo = ($("#recordId").find(':selected').data('record-info'));
			if(recordInfo !="undefined" ){
				var recordType = dijit.byId('recordType').get('value');
				$('.record-img').attr('src', recordInfo.photoUrl);
				
				var strInfo="";
				if(recordType==1){
					$('#recordCode').val(recordInfo.studentCode);
					$('.recordNo').html(recordInfo.studentCode);
					$('.recordNameKh').html(recordInfo.studentNameKh);
					$('.recordNameEng').html(recordInfo.studentNameEng);
				
					strInfo+='<li><i class="fa fa-graduation-cap"></i> <?php echo $tr->translate("ACADEMIC_YEAR");?> '+recordInfo.academicYear+'</li>';
					strInfo+='<li><i class="fa fa-building"></i> <?php echo $tr->translate("GROUP_CODE");?> '+recordInfo.groupCode+'</li>';
					strInfo+='<li><i class="fa fa-phone"></i> <?php echo $tr->translate("TEL");?> '+recordInfo.tel+'</li>';
				}else if(recordType==2 || recordType==3 || recordType==4 ){
					$('#recordCode').val(recordInfo.familyCode);
					$('.recordNo').html(recordInfo.familyCode);
					$('.recordNameKh').html(recordInfo.familyName);
					$('.recordNameEng').html(recordInfo.familyNameEn);
					strInfo+='<li><i class="fa fa-briefcase"></i> <?php echo $tr->translate("TYPE");?> '+recordInfo.familyTypeTitle+'</li>';
					strInfo+='<li><i class="fa fa-building"></i> <small><?php echo $tr->translate("NUMBER_HOME");?> <strong>'+recordInfo.houseNo+'</strong>, <?php echo $tr->translate("STREET");?> </strong>'+recordInfo.street+'</strong>, <?php echo $tr->translate("DISTRICT");?> <strong>'+recordInfo.districtName+'</strong>,<?php echo $tr->translate("CITY_PROVINCE");?> <strong>'+recordInfo.provinceName+'</strong></small></li>';
					strInfo+='<li><i class="fa fa-phone"></i> <?php echo $tr->translate("TEL");?> '+recordInfo.familyPhone+'</li>';
				}else if(recordType==5 || recordType==6 ){
					$('#recordCode').val(recordInfo.staffCode);
					$('.recordNo').html(recordInfo.staffCode);
					$('.recordNameKh').html(recordInfo.staffNameKh);
					$('.recordNameEng').html(recordInfo.staffNameEn);
				
					if(recordType==6){
						strInfo+='<li><i class="fa fa-briefcase"></i> <?php echo $tr->translate("TYPE");?> '+recordInfo.departmentTitle+'</li>';
					}else{
						strInfo+='<li><i class="fa fa-briefcase"></i> <?php echo $tr->translate("TYPE");?> '+recordInfo.staffTypeTitle+'</li>';
					}
					
					
					strInfo+='<li><i class="fa fa-phone"></i> <?php echo $tr->translate("TEL");?> '+recordInfo.tel+'</li>';
				}
				$('.recordMoreInfo').html(strInfo);           
				
			}
		}
	}
}

var urlGetData = '<?php echo $this->url(array('module' => 'setting', 'controller' => 'photomg', 'action' => 'get-record-list')); ?>';
function getRecordOption(){
	
	var recordType = dijit.byId('recordType').get('value');
	var labelTitle = '<?php echo $tr->translate("STUDENT");?>';
	if(recordType==2){
		labelTitle = '<?php echo $tr->translate("FATHER");?>';
	}else if(recordType==3){
		labelTitle = '<?php echo $tr->translate("MOTHER");?>';
	}else if(recordType==4){
		labelTitle = '<?php echo $tr->translate("GUARDIAN");?>';
	}else if(recordType==5){
		labelTitle = '<?php echo $tr->translate("TEACHER");?>';
	}else if(recordType==5){
		labelTitle = '<?php echo $tr->translate("STAFF");?>';
	}
	$("#recordInfo").html(labelTitle);
	
	photoStatus = dijit.byId("photoStatus").get("value");
	branchId = dijit.byId("branchId").get("value");
	if (branchId == '') {
		dijit.byId("branchId").focus();
		return false;
	}
	dojo.xhrPost({
		url: urlGetData,
		content: {
			'branchId': branchId
			,'recordType': recordType
			,'photoStatus': photoStatus
			,'joinGroup': 1
			,'itemType': 1
			,'isMaingrad': 1
			,'isCurrent': 1
			,'activStudent': 1
			,'customerType': 1
			,'option': 1
			
		},
		handleAs: "json",
		load: function (data) {
			$('#recordId').empty().trigger("change");
			$('#recordId').append(data).trigger('change');
			
		},
		error: function (err) {
		}
	});
}

function getImageFile(base64data){
	$('#baseFileUpload').val(base64data);
	if (dijit.byId('frmUploadPhoto').validate()) {
		branchId = dijit.byId('branchId').get('value');
		if(branchId==-1 || branchId=="" ){
			 dijit.byId("branchId").focus();
			return false;
		}
		var recordId = $('#recordId').find(":selected").val();
		if(recordId=="" || recordId==0 ){
			$('#recordId').select2('open');
			return false;
		}
		loadingBlock();
		$('#frmUploadPhoto').submit();
	}
}
</script> 
