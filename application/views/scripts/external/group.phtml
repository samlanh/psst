<?php 
	$tr=Application_Form_FrmLanguages::getCurrentlanguage();
	$baseUrl = $this->baseUrl()."/";
	$pageTitle = $tr->translate("CLASS_LIST");
	echo $this->headTitle($pageTitle);
	$frm =  $this->form_search;
	//print_r($this->allClass);
?>
<?php 
	echo $this->render('externalHead.phtml');
?>
<style>
	ul {
	display: inline;
	margin: 0;
	padding: 0;
	}
	ul.sub_list li:hover{
		background-color: #cccccc;
	}
	ul.sub_list li{
		float: left;
		
		list-style: none;
	}
	ul.bg-color li{
		background-color: #cccccc;
		padding: 3px;
		border-radius: 3px;
	}
	ul.bg li{
		background-color: white;
		padding: 3px;
		border-radius: 3px;
	}
	a.mini-button-class {
    padding: 3px;
    font-size: 10px;
    color: #fff;
    background-color: #0150a6;
    border-color: #004b9c;
    border-radius: 6px;
    width: 70px  !important;
    display: block;
	}
	a.mini-button-class-edit {
    padding: 3px;
    font-size: 10px;
	color: #ffffff;
    background-color: #d1a00c;
    border-color: #004b9c;
    border-radius: 6px;
    width: 70px  !important;
    display: block;
	}
	span.mini-button-class-success {
    padding: 3px;
    font-size: 10px;
    color: #fff;
    background-color: green;
    border-color: #004b9c;
    border-radius: 6px;
    width: 70px  !important;
    display: block;
	}
	span.mini-button-class-loading {
    padding: 3px;
    font-size: 10px;
    color: #fff;
    background-color: #313b4e;
    border-color: #004b9c;
    border-radius: 6px;
    width: 70px  !important;
    display: block;
	}
</style>
	
	<div class="row"> 
		<div class="col-md-12 col-sm-12 col-xs-12">
			<div class="card mb-1 pb-3">
				<div class="card-header pb-1"> 
					<h3 class="card-title mb-1 "><?php echo $tr->translate("SEARCH"); ?></h3> 
				</div>
				<div class="card-content">
					<div class="card-body">
						<form id="list" name="list" action="" dojoType="dijit.form.Form" method="post">
							<div class="form-group">
								<div class="col-md-2 col-sm-2 col-xs-12">
									<?php echo $frm->getElement("adv_search");?>
								</div>
								<!--
								<div class="col-md-2 col-sm-3 col-xs-12">
									<?php //echo $frm->getElement("branch_id");?>
							   </div>
								-->
							   <div class="col-md-2 col-sm-2 col-xs-12">
									<?php echo $frm->getElement("academic_year");?>
							   </div>
							   <div class="col-md-2 col-sm-2 col-xs-12">
									<?php echo $frm->getElement("degree");?>
							   </div>
							   <div class="col-md-2 col-sm-2 col-xs-12">
									<input id="grade" />
							   </div>
							   <div class="col-md-2 col-sm-3 col-xs-12">
									<?php echo $frm->getElement("is_pass");?>
								</div>
								<div class="col-md-2 col-sm-2 col-xs-12">
									<button class="button-class button-primary" iconClass="glyphicon glyphicon-search" dojoType="dijit.form.Button" showLabel="true" type="submit"><?php echo $tr->translate("SEARCH");?></button>
								</div>
						   </div>
					   </form>
				   </div>
			   </div>
			   
			   <div class="row"> 
					<?php 
					//print_r($this->allClass);
				
					if(!empty($this->allClass)) foreach($this->allClass as $row){ 
						$cardClass = "border-top-primary border-top-darken-1";
						$bgClass = "border-primary bg-gradient-directional-primary";
						if($row['examType']==2){
							$cardClass = "border-top-warnings border-top-darken-1";
							$bgClass = "border-warnings bg-gradient-directional-warnings";
						}
					?>
					<div class="col-md-3 col-sm-3 col-xs-12"> 
						<div class="card mb-0 <?php echo $cardClass; ?> border-top-5">
							<div class="card-content">
								<div class="row d-flex mb-1">
									<div class="col-xs-5 pr-0">
										<div class="d-flex align-items-center h-100 text-white  <?php echo $bgClass; ?>">
											<i class="mt-0 mb-0 mr-auto ml-auto glyphicon glyphicon-education icon-opacity text-white font-large-4"></i>
											<strong><?php echo $row['group_code']; ?></strong>
										</div>
									</div>
									<div class="col-xs-7 pl-0">
										<div class="col-md-12 col-sm-12 col-xs-12 ">
											<h4 class="mb-0 text-primary"><?php echo $row['title']; ?></h4>
											<h4 class="mb-1 text-warning"><?php echo $row['subjectTitleKh']; ?>/<?php echo $row['subjectTitleEng']; ?></h4>
										
											<p class="mb-0 mt-0"><i class="glyphicon glyphicon-map-marker" aria-hidden="true"></i>&nbsp;<?php echo $row['branchName']; ?></p>
											<p class="mb-0"><i class="glyphicon glyphicon-education" aria-hidden="true"></i>&nbsp;<?php echo $row['academicYear']; ?></p>
											<p class="mb-0 "><i class="fa fa-file-text-o" aria-hidden="true"></i>&nbsp;<?php echo $row['forTypeTitle']."  ".$row['forMonthTitle']; ?></p>
											<p class="mb-0 "><i class="glyphicon glyphicon-calendar" aria-hidden="true"></i>&nbsp;<?php echo $row['fromDate']." / ".$row['endDate']; ?></p>
										
											
										</div>
									</div>
								</div>
								<div class="col-md-12 col-sm-12 col-xs-12 ">
									<?php   
										// $dbg = new Application_Model_DbTable_DbGlobal();
									
										$dbExternal = new Application_Model_DbTable_DbExternal;
										$gradingId= $row['gradingId'];
										$examType= $row['examType'];
										$subjectId= $row['subjectId'];
										$data = array(
											'gradingId' => $gradingId
											,'examType' => $examType
											,'subjectId' => $subjectId
										);
										$criterial = $dbExternal -> getCriterialByGrading($data);
										$no =0;
										if(!empty($criterial)) foreach($criterial as $key => $rsCriterial){ 
											 $no++;
										?>
										<ul class="sub_list <?php echo ($key%2)==0?'bg-color':'bg';?>">
											
											<?php 
												$currentDate = date('Y-m-d');
												if($rsCriterial['criteriaType']==2){ ?>

													<li style="width: 75%;" >
													<?php echo $no.". ".$rsCriterial['criterialTitle']." / ".$rsCriterial['criterialTitleEng']; ?> <br>
														<small class="text-primary">&nbsp; &nbsp; &nbsp; <i class="glyphicon glyphicon-calendar" aria-hidden="true"></i>&nbsp; <?php echo $row['examFromDate']." / ".$row['examEndDate']; ?></small>
													</li>

												<?php 	
												if( $currentDate >= $row['examFromDate'] AND $currentDate <= $row['examEndDate']){
														if($row['IsExam']>0 AND $row['isLock'] ==0) {
														?>

														<li style="width: 25%; text-align:center;" >
															<a target="_blank" class="mini-button-class-edit" href="<?php echo $this->baseUrl()."/grading/edit/id/".$row['groupId'].'/gradingRowId/'.$row['IsExam'];?>">
																<i class="glyphicon glyphicon-edit" aria-hidden="true"></i> <?php echo $tr->translate('EDIT');?>
															</a>
														</i>

													<?php }elseif($row['IsExam']>0 AND $row['isLock'] ==1){   ?>

														<li style="width: 25%; text-align:center;" >
															<span class="mini-button-class-success" >
																<i class="glyphicon glyphicon-ok-circle" aria-hidden="true"></i> <?php echo $tr->translate('Completed');?>
															</span>
														</i>

												<?php	}else{  ?>

														<li style="width: 25%; text-align:center;" >
																<a target="_blank" class="mini-button-class" href="<?php echo $this->baseUrl()."/grading/index/id/".$row['groupId']."/criteriaId/".$rsCriterial['criteriaId']."/subjectId/".$row['subjectId']."/settingEntryId/".$row['id'];?>">
																		<i class="glyphicon glyphicon-sort-by-order" aria-hidden="true"></i> <?php echo $tr->translate('INPUT_SCORE');?>
																</a>
															</i>
													<?php }	
											}else{ ?>
														<li style="width: 25%; text-align:center;" >
															<span class="mini-button-class-loading" >
																<i class="glyphicon glyphicon-hourglass" aria-hidden="true"></i> <?php echo $tr->translate('Not Allowed');?>
															</span>
														</i>
												<?php	}}else{ ?>
												<li style="width: 75%;" ><?php echo $no.". ".$rsCriterial['criterialTitle']." / ".$rsCriterial['criterialTitleEng']; ?></li>
												<li style="width: 25%; text-align:center;" >
													<a target="_blank" class="mini-button-class" href="<?php echo $this->baseUrl()."/grading/index/id/".$row['groupId']."/criteriaId/".$rsCriterial['criteriaId']."/subjectId/".$row['subjectId']."/settingEntryId/".$row['id'];?>">
														<i class="glyphicon glyphicon-sort-by-order " aria-hidden="true"></i> <?php echo $tr->translate('INPUT_SCORE');?>
													</a>
												</i>
											<?php } ?>
										</ul>
									<?php  } ?>
									<div style="clear:both;"></div>
								</div>

							</div>
						</div>
					</div>
					<?php } ?>
				</div> 
	
			</div>
		</div>
	</div>
	
<script src="<?php echo $this->baseUrl();?>/js/help.js"  type="text/javascript"></script>	
<script type="text/javascript">
$( document ).ready(function() {
   setPageTitle('<?php echo $pageTitle; ?>');
});

dojo.require("dojo.data.ItemFileWriteStore"); 
dojo.ready(function(){

	new dijit.form.FilteringSelect({
		queryExpr: "*${0}*",
		autoComplete: false, 
		required: false,
		id: "grade",
		name: "grade",           
		class: 'fullside',  
		placeHolder:"<?php echo $tr->translate("SELECT_GRADE");?>",          
		onChange: function() {  
		}
	}, "grade");
	
	getallGrade();
	<?php if(!empty($this->search['academic_year'])){?>
	 dijit.byId('academic_year').attr('value','<?php echo $this->search['academic_year'];?>'); 
	<?php } ?>
});

var url_dept = '<?php echo $this->url(array('module'=>'global','controller'=>'grade','action'=>'get-grade')); ?>';
function getallGrade(){
	dept_id = dijit.byId('degree').get('value');
	if(dept_id=='' || dept_id==-1){return false;}
		dojo.xhrPost({
			url:url_dept,
			content:{
				'dept_id':dept_id,
				'noaddnew':1
				},
			handleAs:"json",
			load: function(data) {
				dijit.byId('grade').attr('value','');
				grade_store  = getDataStorefromJSON('id','name', data);
			    dijit.byId('grade').set('store',grade_store); 
			    dijit.byId('grade').attr('value','<?php echo $this->search['grade']?>');    
			},
			error: function(err) {
			}
		});
}
</script>
<?php 
	echo $this->render('externalFoot.phtml');
?>