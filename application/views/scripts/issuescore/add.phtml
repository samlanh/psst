<?php
	$tr = Application_Form_FrmLanguages::getCurrentlanguage();
	
	$pageTitle = $tr->translate("ISSUE_SCORE");
	echo $this->headTitle($pageTitle);
	$base_url = Application_Form_FrmMessage::getUrl("/");
	
	$pageTitle = '<i class="glyphicon glyphicon-pencil"></i> '.$pageTitle;

	
	$current_month = date("m");
?>	
<?php 
	echo $this->render('externalHead.phtml');
?>
<div class="row"> 
	<div class="col-md-12 col-sm-12 col-xs-12">
		<div class="card mb-1 ">
			<div class="card-header pb-1"> 
				<h3 class="card-title mb-2 "><?php echo $this->row['branch_name'].' "'.$tr->translate("GROUP")." ".$this->row['group_code'].'"'?></h3> 
			</div>
			<div class="card-content collapse show mt-1">
				<form id='office_receipt' action="" dojoType="dijit.form.Form" method="post" enctype="application/x-www-form-urlencoded">
					<script type="dojo/method" event="onSubmit">   
					if(this.validate()){
						var identity = $('#identity').val();
						if(identity==''){
							alert("There is no record to save");
							return false;
						}
						var rowId = $('#identity').val();
						if(rowId==''){ 
							alert("<?php echo $tr->translate('NO_RECORD_TO_SUBMIT');?>");
							return false;
						}
						var txt;
						var r = confirm("Are you sure to submit ?");
						if(r == true){
							 dijit.byId('save_new').set('disabled',true);
							 loadingBlock();
							 return true;
						}else{
							  return false;
						}
					}else {
						return false;
					}
					</script>
					<div class="card-box">
						<div class="col-md-6 col-sm-6 col-xs-12">
							
							 <div class="form-group">
								<label class="control-label bold col-md-5 col-sm-5 col-xs-12"><?php echo $tr->translate("EXAM_TITLE");?> <span class="required">*</span></label>
								<div class="col-md-7 col-sm-7 col-xs-12">
									<input type="text" name="title" id="title" class="fullside" required="1" dojoType="dijit.form.ValidationTextBox" />
									<input type="hidden" name="branch_id" id="branch_id" class="fullside" required="1" dojoType="dijit.form.ValidationTextBox" value="<?php echo $this->row['branch_id']?>" />
									<input type="hidden" name="group" id="group" class="fullside" required="1" dojoType="dijit.form.ValidationTextBox" value="<?php echo $this->row['id']?>"/>
								</div>
							 </div>
							 <div class="form-group">
								<label class="control-label bold col-md-5 col-sm-5 col-xs-12"><?php echo $tr->translate("EXAM_TYPE");?> <span class="required">*</span></label>
								<div class="col-md-7 col-sm-7 col-xs-12">
									<select id="exam_type" name="exam_type" class="fullside" onchange="checkExamType();getSubjectByGroup();"  dojoType="dijit.form.FilteringSelect" >
										<option value="1"><?php echo $tr->translate("MONTHLY");?></option>
										<option value="2"><?php echo $tr->translate("SEMESTER");?></option>
									</select>
								</div>
							 </div>
							  <div class="form-group">
								<label class="control-label bold col-md-5 col-sm-5 col-xs-12"><?php echo $tr->translate("SORT_STUDENT");?></label>
								<div class="col-md-7 col-sm-7 col-xs-12">
									<select id="sortStundent" name="sortStundent" class="fullside" onchange="getSubjectByGroup()"  dojoType="dijit.form.FilteringSelect" >
										<option value="0"><?php echo $tr->translate("DEFAULT");?></option>
										<option value="1"><?php echo $tr->translate("BY_STU_CODE_ASC");?></option>
										<option value="2"><?php echo $tr->translate("BY_STU_KHNAME_ASC");?></option>
										<option value="3"><?php echo $tr->translate("BY_STU_ENNAME_ASC");?></option>
									</select>
								</div>
							 </div>
							
							 <div class="form-group examtype_display">
								<label class="control-label col-md-5 col-sm-5 col-xs-12"><?php echo $tr->translate("FOR_MONTH");?> <span class="required">*</span></label>
								<div class="col-md-7 col-sm-7 col-xs-12">
									<select dojoType="dijit.form.FilteringSelect" required="true" class="fullside" id="for_month" name="for_month" queryExpr="*${0}*" autoComplete="false">								
										<?php if(!empty($this->month)){foreach ($this->month as $month){?>
											<option value="<?php echo $month['id']?>" <?php if($month['id']==$current_month){echo "selected='selected'";}?>><?php echo $month['month_kh']?></option>
										<?php }}?>
									</select>
								</div>
							 </div>
							 <div class="form-group">
									<label class="control-label col-md-5 col-sm-5 col-xs-12"><?php echo $tr->translate("FOR_SEMESTER");?> <span class="required">*</span></label>
									<div class="col-md-7 col-sm-7 col-xs-12">
										<select dojoType="dijit.form.FilteringSelect" required="true" class="fullside" id="for_semester" name="for_semester" queryExpr="*${0}*" autoComplete="false">								
											<option value="1"><?php echo $tr->translate("SEMESTER1");?></option>
											<option value="2"><?php echo $tr->translate("SEMESTER2");?></option>
										</select>
									</div>
								 </div>
								
								  
						  </div>
						  <div class="col-md-6 col-sm-6 col-xs-12">
								<div class="card-info bg-gradient-directional-warning">
									<div class="card-content">
										<div class="card-body">
											<div class="media d-flex">
												<div class="media-body text-white text-left align-self-bottom ">
													<span class="d-block mb-1 font-medium-1"></span>
													<h3 class="text-white mb-10"><?php echo $tr->translate("GROUP_STUDENT_INFO");?></h3>
													<ul class="optListRow">
														<li class="opt-items two-column"><span class="lbl-tt"><?php echo $tr->translate("ACADEMIC_YEAR");?></span>: <span class="text-value"><?php echo $this->row['academic']?></span></li>
														<li class="opt-items two-column"><span class="lbl-tt"><?php echo $tr->translate("DEGREE");?></span>: <span class="text-value"><?php echo $this->row['degree']?></span></li>
														<li class="opt-items two-column"><span class="lbl-tt"><?php echo $tr->translate("ROOM");?></span>: <span class="text-value"><?php echo $this->row['room_name']?></span></li>
														<li class="opt-items two-column"><span class="lbl-tt"><?php echo $tr->translate("GRADE");?></span>: <span class="text-value"><?php echo $this->row['grade']?></span></li>
													</ul>
												</div>
												<div class="align-self-top">
												<i class="glyphicon glyphicon-briefcase icon-opacity text-white font-large-4 float-end"></i>
												</div>
											</div>
										</div>
									</div>
								</div>
								<div class="form-group">
									<div class="col-md-12 col-sm-12 col-xs-12">
										 <input class="fullside" placeholder="<?php echo $tr->translate("NOTE");?>" dojoType="dijit.form.Textarea"  id="note" name="note" value="" type="text" style=" height: 120px !important;"  >
									</div>
								 </div>
								 <input class="fullside" dojoType="dijit.form.TextBox"  id="year_study" name="year_study" value="" type="hidden"  >
								 <input class="fullside" dojoType="dijit.form.TextBox"  id="degree" name="degree" value="" type="hidden"  >
								 <input class="fullside" dojoType="dijit.form.TextBox"  id="grade" name="grade" value="" type="hidden"  >
								 <input class="fullside" dojoType="dijit.form.TextBox"  id="grade_fromgrouop" name="grade_fromgrouop" value="" type="hidden"  >
								 <input class="fullside" dojoType="dijit.form.TextBox"  id="session" name="session" value="" type="hidden"  >
							 
								 
						  </div>
					 </div>
					 <div class="card-box">
						<div class="col-md-12 col-sm-12 col-xs-12">
							<div class="form-group">
								<input type="hidden" name="identity" id="identity"  value="" >
								<table id="table_row" style="border-collapse: collapse; border:1px solid #ccc;width:100%" >
								</table>
							</div>
						</div>
				   </div>
				   <div class="clearfix"></div>
					 <div class="card-box mt-20">
						<div class="col-md-12 col-sm-12 col-xs-12 border-top mt-20 ptb-10 text-center">
							<input type="submit" class="button-class button-primary" iconClass="glyphicon glyphicon-floppy-remove" value="save_close" name="save_close" label="<?php echo $tr->translate('SAVE_CLOSE');?>" dojoType="dijit.form.Button" />
							<input type="submit" class="button-class button-primary" iconClass="glyphicon glyphicon-floppy-disk" value="save_new" id="save_new" name="save_new" label="<?php echo $tr->translate('SAVE_NEW');?>" dojoType="dijit.form.Button"  />
						</div>
					 </div>
				</form>
			</div>
		</div>
	</div>
</div>
<script type="text/javascript">

$( document ).ready(function() {
   setPageTitle('<?php echo $pageTitle; ?>');
});
dojo.require("dijit.form.Textarea");
dojo.require("dijit.form.DateTextBox");
dojo.require('dijit.form.NumberTextBox');
dojo.require("dojo.NodeList-manipulate");
dojo.ready(function(){
	getSubjectByGroup();
});



var inx=0;
var url_getStudent= '<?php echo $this->url(array('module'=>'issue','controller'=>'score','action'=>'get-student')); ?>';
function filterStudent(){
	$('#identity').val('');
	dojo.query("#table_row").append("");
	loadingBlock();
	
	group = dijit.byId('group').get('value');
	sortStundent = dijit.byId('sortStundent').get('value');
	amtsubject = 0;
	exam_type = dijit.byId('exam_type').get('value');
	if(group==''){
		return false;
	}
	dojo.xhrPost({
	    url: url_getStudent,
	    content : { 
			'group':group,
			'sortStundent':sortStundent,
		},				    
	   handleAs:"json", 
	   load: function(data) {
		   tem="";
		   temp='';
	       if(data!=""){
				title=0;
				temp='';
				str='';
				column = 0;
				record_num = 0;
				temp='<table class="collape responsiveTable" id="table" >'
					+'<thead>'
					+'<tr class="head-td" align="center">'
					+'<td scope="col" width="10px"  ><?php echo $tr->translate('DEL');?></td>'
					+'<td scope="col" width="10px"  ><?php echo $tr->translate('NUM');?></td>'
					+'<td scope="col"  style="width:80px;"><?php echo $tr->translate('STUDENT_ID');?></td>'
					+'<td scope="col"  style="width:120px;"><?php echo $tr->translate('STUDENT_NAME');?></td>'
					+'<td scope="col" ><?php echo $tr->translate('SEX');?></td>'
					no=0;
				
				  for(j=0;j<subject.length;j++){
					 
	      			  no++;
		      		  amtsubject = subject[j].amount_subjectdivide;
		      		  stringsname = subject[j].name;
		      	      temp+='<td scope="col" class="verites-col" title="'+stringsname+'"><span class="verites">&nbsp;'+no+'-'+stringsname+'&nbsp;</span></td>';
	              }
				  temp+='<td scope="col" ><?php echo $tr->translate('AMOUNT_SUBJECT');?></td>';
				  temp+='<td scope="col"><?php echo $tr->translate('NOTE');?></td>'+'</tr>';
				  temp+='<tr class="head-td" align="center">';
				  temp+='<td scope="col" >&nbsp;</td>';
				  temp+='<td scope="col" >&nbsp;</td>';
				  temp+='<td scope="col" >&nbsp;</td>';
				  temp+='<td scope="col" >&nbsp;</td>';
				  temp+='<td scope="col" >&nbsp;</td>';
					  no=0;
					  for(j=0;j<subject.length;j++){
		      			  no++;
		      			  //stringsname = subject[j].subject_titleen.replace(' ','');
			      		  stringsname = subject[j].subject_titleen;
			      	      temp+='<td scope="col" title="'+stringsname+'"><input  checked="checked" style=" display: inline-block; height: 15px; margin-right: 10px;" type="checkbox" onClick="CheckSubjectExam('+subject[j].subject_id+');"  class="checkbox" id="subject'+subject[j].subject_id+'" value="'+subject[j].subject_id+'"  name="selector[]"/></td>';
		              }
				  temp+='<td scope="col">&nbsp;</td>';
			  	  temp+='<td scope="col">&nbsp;</td>';
				  temp+='</tr>';
				  temp+='</thead>';
				var rowClasss="";
				for(i=0;i<data.length;i++){
					inx = inx+1;
					record_num ++;
					rowClasss="odd"
					if((i%2)==0){
						rowClasss= "regurlar";
					}
					temp += '<tr class="rowData hover normal '+rowClasss+'" id="row'+inx+'">';
					temp +='<td data-label="<?php echo $tr->translate("REMOVE_RECORD");?>"  align="center"><span title="<?php echo $tr->translate("REMOVE_RECORD");?>" class="removeRow" onclick="deleteRecord('+inx+')" ><i class="glyphicon glyphicon-trash" aria-hidden="true"></i></span></td>';
					temp +='<td data-label="<?php echo $tr->translate("NUM");?>"  align="center">&nbsp;'+record_num+'</td>';
					temp +='<td data-label="<?php echo $tr->translate("STUDENT_ID");?>"  align="left">&nbsp;'+data[i].stu_code+'<input dojoType="dijit.form.TextBox" name="student_id'+inx+'" value="'+data[i].stu_id+'" type="hidden" ></td>';
					temp +='<td data-label="<?php echo $tr->translate("STUDENT_NAME");?>"  align="left">'+data[i].stuKhName+'<br />'+data[i].stuEnName+'</td>';
					temp +='<td data-label="<?php echo $tr->translate("SEX");?>" >'+gender(data[i].sex)+'</td>';
					for(j=0;j<subject.length;j++){
						maxValue = "'The value maximumn "+subject[j].max_subjectscore+"'";
						invalidesms = "rangeMessage:"+maxValue;
						stringsname = subject[j].subject_titleen;
						temp += '<td data-label="'+stringsname+'" id="score_'+j+'"><input value="0" data-dojo-props="constraints:{min:0,max:'+subject[j].max_subjectscore+'},'+invalidesms+'" required="1" class="fullside" dojoType="dijit.form.NumberTextBox" type="text" id="score_'+inx+'_'+subject[j].subject_id+'"  name="score_'+inx+'_'+subject[j].subject_id+'" /></td>';
					}
					temp += '<td data-label="<?php echo $tr->translate("AMOUNT_SUBJECT");?>"><input class="fullside" dojoType="dijit.form.NumberTextBox" type="text" value="'+amtsubject+'" id="amount_subject'+inx+'"  name="amount_subject'+inx+'" ></td>';
					temp += '<td data-label="<?php echo $tr->translate("NOTE");?>"><input dojoType="dijit.form.TextBox" class="fullside" name="note_'+inx+'"  value="" type="text" ></td>';
					temp+= '</tr>';
					var no=0;
				    if($("#identity").val()!=""){
						var identity = $("#identity").val();
						$("#identity").val(identity+','+inx);
					} else {$("#identity").val(inx);}
				}
				temp+='</table>';
				tmp='<tr id="rowindex'+inx+'">';
				tmp+="</tr>";
				dojo.query("#table_row").append(tmp);
				dojo.html.set(dojo.byId("rowindex"+inx),temp , {
				     parseContent: true,
				});
	       }else{
		    	$('#identity').val('');
	       }
	   },		
	    error: function(err) {
	    }
	});
	HideloadingBlock();
}
function CheckSubjectExam(subject_id){
	var rowId = $('#identity').val();
	var amountsub = $(".checkbox:checked").length;
	if ($('#subject'+subject_id).is(':checked')) {
		if(rowId!=''){ 
			var rowIDArray = rowId.split(',');
			for(var b = 0; b < rowIDArray.length; b++){
				dijit.byId('score_'+rowIDArray[b]+'_'+subject_id).set('disabled',false);
				dijit.byId('score_'+rowIDArray[b]+'_'+subject_id).attr('value',0);
				dijit.byId('score_'+rowIDArray[b]+'_'+subject_id).set('required',true); 
			}
		}
	}else{
		if(rowId!=''){ 
			var rowIDArray = rowId.split(',');
			for(var b = 0; b < rowIDArray.length; b++){
				dijit.byId('score_'+rowIDArray[b]+'_'+subject_id).set('disabled',true);
				dijit.byId('score_'+rowIDArray[b]+'_'+subject_id).attr('value',0);
				dijit.byId('score_'+rowIDArray[b]+'_'+subject_id).set('required',false); 
			}
		}
	}
}
function deleteRecord(index){
	var identity = $('#identity').val();
	var arrays = identity.split(',');
	for(var i=0;i<arrays.length;i++) {
		if(arrays[i] == index) arrays.splice(i,1);
	}
	var strings = arrays.join(',');
	$('#identity').val(strings);
	dojo.query("#row"+index).remove();
}
function gender(sex){
	if(sex==1){
		sex='<?php echo $tr->translate('MALE');?>';
	}else sex='<?php echo $tr->translate('FEMALE');?>';
	return sex;
}
function checkExamType(){
	exam_type = dijit.byId("exam_type").get("value");
	dijit.byId('for_month').set("readOnly",false);
	$(".examtype_display").css("display", "flow-root");
	if(exam_type==2){
		dijit.byId('for_month').set("readOnly",true);
		$(".examtype_display").css("display", "none");
	}
}

var url_getSubject= '<?php echo $this->url(array('module'=>'issue','controller'=>'score','action'=>'get-subjectbygroup')); ?>';
function getSubjectByGroup(){
	group = dijit.byId('group').get('value');
	exam_type = dijit.byId('exam_type').get('value');
	if(group==''){
		$('#identity').val('');
		dojo.query("#table_row").append("");
		return false;
	}
	dojo.xhrPost({
	    url: url_getSubject,
	    content : { 
			'group':group,
			'exam_type':exam_type
		},				    
	   handleAs:"json", 
	   load: function(data) {
		   subject = data;
		   filterStudent()
	   },		
	    error: function(err) {
	    }
	});
}
</script>
<?php 
	echo $this->render('externalFoot.phtml');
?>