<?php
	$tr = Application_Form_FrmLanguages::getCurrentlanguage();
	
	$pageTitle = $tr->translate("EDIT_ISSUE_SCORE");
	echo $this->headTitle($pageTitle);
	$base_url = Application_Form_FrmMessage::getUrl("/");
	
	$pageTitle = '<i class="fa fa-edit"></i> '.$pageTitle;

	
	$student = $this->student;
	$db_score = new Application_Model_DbTable_DbIssueScore();	 
?>	
<?php 
	echo $this->render('externalHead.phtml');
?>
<div class="row"> 
	<div class="col-md-12 col-sm-12 col-xs-12">
		<div class="card mb-1 ">
			<div class="card-header pb-1"> 
				<h3 class="card-title mb-2 "><?php echo $this->rs['branchName'].' "'.$tr->translate("GROUP")." ".$this->rs['groupCode'].'"'?></h3> 
			</div>
			<div class="card-content collapse show mt-1">
				<form id='office_receipt' action="" dojoType="dijit.form.Form" method="post" enctype="application/x-www-form-urlencoded">
					<script type="dojo/method" event="onSubmit">   
					if(this.validate()){
						var identity = $('#identity').val();
						if(identity==''){
							alert("There is no record to save");
							return false;
						}
						var rowId = $('#identity').val();
						if(rowId==''){ 
							alert("<?php echo $tr->translate('NO_RECORD_TO_SUBMIT');?>");
							return false;
						}
						var txt;
						var r = confirm("Are you sure to submit ?");
						if(r == true){
							 dijit.byId('save_new').set('disabled',true);
							 loadingBlock();
							 return true;
						}else{
							  return false;
						}
					}else {
						return false;
					}
					</script>
					<div class="card-box">
						<div class="col-md-6 col-sm-6 col-xs-12">
							<div class="card-blogform">
								<div class="card-body"> 
									<div class="row"> 
										<div class="col-md-12 col-sm-12 col-xs-12"> 
											<div class="d-flex"> 
												<div class="settings-main-icon ">
													<i class="glyphicon glyphicon-pencil" aria-hidden="true"></i>
												</div> 
												<div class="col-md-10 col-sm-10 col-xs-12"> 
													<p class="tx-20 font-weight-semibold d-flex "><?php echo $tr->translate('SCORE_INFO')?> </p>
													
												</div> 
											</div>
											 <div class="form-group">
												<label class="control-label bold col-md-5 col-sm-5 col-xs-12"><?php echo $tr->translate("EXAM_TITLE");?></label>
												<div class="col-md-7 col-sm-7 col-xs-12">
													<input type="text" name="title" id="title" class="fullside" required="1" dojoType="dijit.form.ValidationTextBox" placeholder="<?php echo $tr->translate("SCORE_FOR_JANUARY");?>..." value="<?php echo $this->rs['title_score']?>" />
													<input type="hidden" name="score_id" id="score_id" class="fullside" required="1" dojoType="dijit.form.ValidationTextBox" value="<?php echo $this->rs['id']?>" />
													<input type="hidden" name="branch_id" id="branch_id" class="fullside" required="1" dojoType="dijit.form.ValidationTextBox" value="<?php echo $this->rs['branch_id']?>" />
													<input type="hidden" name="group" id="group" class="fullside" required="1" dojoType="dijit.form.ValidationTextBox" value="<?php echo $this->rs['group_id']?>"/>
												</div>
											 </div>
											 <div class="form-group">
												<label class="control-label bold col-md-5 col-sm-5 col-xs-12"><?php echo $tr->translate("SCORE_FOR");?></label>
												<div class="col-md-7 col-sm-7 col-xs-12">
													<div class="col-md-4 col-sm-4 col-xs-12">
														<select id="exam_type" readOnly name="exam_type" class="fullside" onchange="checkExamType();getSubjectByGroup();"  dojoType="dijit.form.FilteringSelect" >
															<option value="1" <?php if(1==$this->rs['exam_type']){echo "selected='selected'";}?>><?php echo $tr->translate("MONTHLY");?></option>
															<option value="2" <?php if(2==$this->rs['exam_type']){echo "selected='selected'";}?>><?php echo $tr->translate("SEMESTER");?></option>
														</select>
													</div>
													<div class="col-md-4 col-sm-4 col-xs-12">
														<select readOnly dojoType="dijit.form.FilteringSelect" required="true" class="fullside" id="for_semester" name="for_semester" queryExpr="*${0}*" autoComplete="false">								
															<option value="1" <?php if(1==$this->rs['for_semester']){echo "selected='selected'";}?>><?php echo $tr->translate("SEMESTER1");?></option>
															<option value="2" <?php if(1==$this->rs['for_semester']){echo "selected='selected'";}?>><?php echo $tr->translate("SEMESTER2");?></option>
														</select>
													</div>
													<div class="col-md-4 col-sm-4 col-xs-12">
														<select readOnly dojoType="dijit.form.FilteringSelect" required="true" class="fullside" id="for_month" name="for_month" queryExpr="*${0}*" autoComplete="false">								
															<?php if(!empty($this->month)){foreach ($this->month as $month){?>
																<option value="<?php echo $month['id']?>" <?php if($month['id']==$this->rs['for_month']){echo "selected='selected'";}?>><?php echo $month['month_kh']?></option>
															<?php }}?>
														</select>
													</div>
												</div>
											 </div>
											 <div class="form-group">
												<label class="control-label bold col-md-5 col-sm-5 col-xs-12"><?php echo $tr->translate("NOTE");?></label>
												<div class="col-md-7 col-sm-7 col-xs-12">
													<input class="fullside" placeholder="<?php echo $tr->translate("NOTE");?>" dojoType="dijit.form.Textarea"  id="note" name="note" value="<?php echo $this->rs['note'];?>" type="text" style=" height: 120px !important;"  >
												</div>
											 </div>
											 											
												<div class="form-group">
													<label class="control-label custom-switch float-end "> 
														<a href="javascript:void(0);" class="switchButton status"><?php echo $tr->translate("STATUS");?></a> 
														<input type="checkbox" id="status" name="status" class="custom-switch-input"  <?php if(!empty($this->rs['status'])){ echo "checked";} ?> > 
														<span class="custom-switch-indicator custom-radius switch-status"></span> 
													</label>
												</div>
										 </div>
									 </div>
								 </div>
							 </div>
							
								
								  
						  </div>
						  <div class="col-md-6 col-sm-6 col-xs-12">
								<div class="card-info bg-gradient-directional-primary">
									<div class="card-content">
										<div class="card-body">
											<div class="media d-flex">
												<div class="media-body text-white text-left align-self-bottom ">
													<span class="d-block mb-1 font-medium-1"></span>
													<h3 class="text-white mb-10"><?php echo $tr->translate("GROUP_STUDENT_INFO");?></h3>
													<ul class="optListRow">
														<li class="opt-items two-column"><span class="lbl-tt"><?php echo $tr->translate("ACADEMIC_YEAR");?></span>: <span class="text-value"><?php echo $this->rs['academicYear']?></span></li>
														<li class="opt-items two-column"><span class="lbl-tt"><?php echo $tr->translate("DEGREE");?></span>: <span class="text-value"><?php echo $this->rs['degreeTitle']?></span></li>
														<li class="opt-items two-column"><span class="lbl-tt"><?php echo $tr->translate("ROOM");?></span>: <span class="text-value"><?php echo $this->rs['roomName']?></span></li>
														<li class="opt-items two-column"><span class="lbl-tt"><?php echo $tr->translate("GRADE");?></span>: <span class="text-value"><?php echo $this->rs['gradeTitle']?></span></li>
													</ul>
												</div>
												<div class="align-self-top">
												<i class="glyphicon glyphicon-briefcase icon-opacity text-white font-large-4 float-end"></i>
												</div>
											</div>
										</div>
									</div>
								</div>
						  </div>
					 </div>
					 <div class="card-box">
						<div class="col-md-12 col-sm-12 col-xs-12">
							<div class="form-group">
								<input type="hidden" name="identity" id="identity"  value="" >
								<table id="table_row" style="border-collapse: collapse; border:1px solid #ccc;width:100%" >
								</table>
							</div>
						</div>
				   </div>
				   <div class="clearfix"></div>
					 <div class="card-box mt-20">
						<div class="col-md-12 col-sm-12 col-xs-12 border-top mt-20 ptb-10 text-center">
							<input type="submit" class="button-class button-primary" iconClass="glyphicon glyphicon-floppy-remove" value="save_close" name="save_close" label="<?php echo $tr->translate('SAVE_CLOSE');?>" dojoType="dijit.form.Button" />
						</div>
					 </div>
				</form>
			</div>
		</div>
	</div>
</div>
<script type="text/javascript">

$( document ).ready(function() {
   setPageTitle('<?php echo $pageTitle; ?>');
});
dojo.require("dijit.form.Textarea");
dojo.require("dijit.form.DateTextBox");
dojo.require('dijit.form.NumberTextBox');
dojo.require("dojo.NodeList-manipulate");
dojo.ready(function(){
	filterStudentOld();
});


function CheckSubjectExam(subject_id){
	var rowId = $('#identity').val();
	var amountsub = $(".checkbox:checked").length;
	if ($('#subject'+subject_id).is(':checked')) {
		if(rowId!=''){ 
			var rowIDArray = rowId.split(',');
			for(var b = 0; b < rowIDArray.length; b++){
				dijit.byId('score_'+rowIDArray[b]+'_'+subject_id).set('disabled',false);
				dijit.byId('score_'+rowIDArray[b]+'_'+subject_id).attr('value',0);
				dijit.byId('score_'+rowIDArray[b]+'_'+subject_id).set('required',true); 
			}
		}
	}else{
		if(rowId!=''){ 
			var rowIDArray = rowId.split(',');
			for(var b = 0; b < rowIDArray.length; b++){
				dijit.byId('score_'+rowIDArray[b]+'_'+subject_id).set('disabled',true);
				dijit.byId('score_'+rowIDArray[b]+'_'+subject_id).attr('value',0);
				dijit.byId('score_'+rowIDArray[b]+'_'+subject_id).set('required',false); 
			}
		}
	}
}
function deleteRecord(index){
	var identity = $('#identity').val();
	var arrays = identity.split(',');
	for(var i=0;i<arrays.length;i++) {
		if(arrays[i] == index) arrays.splice(i,1);
	}
	var strings = arrays.join(',');
	$('#identity').val(strings);
	dojo.query("#row"+index).remove();
}
function gender(sex){
	if(sex==1){
		sex='<?php echo $tr->translate('MALE');?>';
	}else sex='<?php echo $tr->translate('FEMALE');?>';
	return sex;
}
function checkExamType(){
	exam_type = dijit.byId("exam_type").get("value");
	dijit.byId('for_month').set("readOnly",false);
	if(exam_type==2){
		dijit.byId('for_month').set("readOnly",true);
	}
}



inx=0;
function filterStudentOld(){
	dojo.query("#table_row").append("");
	$('#identity').val("");
	loadingBlock();
	num =0;
	title=0;
	temp='';
	str='';
	column = 0;
	temp='<table class="collape responsiveTable" id="table" >'
			+'<thead>'
			+'<tr class="head-td" align="center">'
			+'<th scope="col" width="10px"  ><?php echo $tr->translate('DEL');?></th>'
			+'<th scope="col" width="10px"  ><?php echo $tr->translate('NUM');?></th>'
			+'<th scope="col"  style="width:150px;"><?php echo $tr->translate('STUDENT');?></th>'
			+'<th scope="col" ><?php echo $tr->translate('SEX');?></td>';
					
	
		no=0;
		<?php if (!empty($this->subjectGroup)) foreach ($this->subjectGroup as $index => $subj){ ?>
			  no++;
			  stringsname = '<?php echo str_replace(" ", "", $subj['name'])?>';
			  <?php 
			  $result_score = $db_score->checkSubjectScore($this->rs['id'], $subj["subject_id"],null);
			  ?>
			  
					  
		      temp+='<th scope="col" title="'+stringsname+'">';
		      	      temp+='<div class="custom-control custom-checkbox ">';
						 temp+='<input type="checkbox" class="checkbox custom-control-input" <?php if (!empty($result_score)){?>checked="checked"<?php }?> onClick="CheckSubjectExam(<?php echo $subj["subject_id"]; ?>);"  id="subject<?php echo $subj["subject_id"]; ?>" value="<?php echo $subj["subject_id"]; ?>"  name="selector[]">';
						 temp+='<label class="custom-control-label" for="subject<?php echo $subj["subject_id"]; ?>">';
							 temp+=no+'-'+stringsname;
						 temp+='</label>';
					 temp+='</div>';
			  temp+='</th>';
		<?php }?>
		 temp+='<th scope="col"><?php echo $tr->translate('AMOUNT_SUBJECT');?></th>';
		 temp+='<th scope="col"><?php echo $tr->translate('NOTE');?></th>'+'</tr>';
		  
		  temp+='</thead>';
		 <?php $old_stu = null;$i=0;
			if(!empty($student))foreach ($student as $key=>$rs){
				
				$classs= "odd";
				if(($i%2)==0){
					$classs= "regurlar";
				}
				$i = $i+1;
			?>
				inx = inx+1;
				num++;
				var no=0;
	        	<?php 
	        	?>
	        	temp+='<tr class="rowData <?php echo $classs; ?>" id="row'+inx+'">';
				temp+='<td data-label="<?php echo $tr->translate("REMOVE_RECORD");?>" align="center"><span title="<?php echo $tr->translate("REMOVE_RECORD");?>" class="removeRow" onclick="deleteRecord('+inx+')" ><i class="glyphicon glyphicon-trash" aria-hidden="true"></i></span> </td>';
				temp+='<td data-label="<?php echo $tr->translate("NUM");?>" align="center"><?php echo $i; ?></td>';
				
				temp +='<td data-label="<?php echo $tr->translate("STUDENT");?>"  align="left">';
						temp +='<strong class="text-dark"><?php echo $rs["stu_code"]; ?></strong><br />';
						temp +='<strong class="text-dark"><?php echo $rs["stuKhName"]; ?></strong><br />';
						temp +='<strong class="text-dark"><?php echo $rs["stuEnName"]; ?></strong>';
						temp +='<input type="hidden" dojoType="dijit.form.TextBox" name="student_id'+inx+'" id="student_id'+inx+'" value="<?php echo $rs["student_id"] ?>"/>';
					temp +='</td>';
					
				
				temp +='<td data-label="<?php echo $tr->translate("SEX");?>">'+gender(<?php echo $rs["sex"];?>)+'</td>';
				<?php if (!empty($this->subjectGroup)) foreach ($this->subjectGroup as $index => $subj){ 
					$result_score = $db_score->getStudentScoreBySubjectID($this->rs['id'], $rs["student_id"],$subj['subject_id']);
					?> 
					stringsname = '<?php echo str_replace(" ", "", $subj['name'])?>';
						maxValue = "'The value maximumn <?php echo $subj["max_subjectscore"]; ?>'";
						invalidesms = "rangeMessage:"+maxValue;
					temp += '<td data-label="'+stringsname+'" id="score_<?php echo $index;?>"><input required="1" <?php if (empty($result_score)){?>disabled="disabled"<?php }?> data-dojo-props="constraints:{min:0,max:<?php echo $subj["max_subjectscore"]; ?>},'+invalidesms+'"   class="fullside" dojoType="dijit.form.NumberTextBox" type="text" value="<?php if (!empty($result_score)){ echo $result_score['score'];}else{ echo '0';}?>" id="score_'+inx+'_<?php echo $subj["subject_id"]; ?>"  name="score_'+inx+'_<?php echo $subj["subject_id"]; ?>" /></td>';
				<?php }?>
				temp += '<td data-label="<?php echo $tr->translate("AMOUNT_SUBJECT");?>"><input class="fullside" dojoType="dijit.form.NumberTextBox" type="text" value="<?php echo $rs["amount_subject"]; ?>" id="amount_subject'+inx+'"  name="amount_subject'+inx+'" ></td>';
				temp += '<td data-label="<?php echo $tr->translate("NOTE");?>"><input dojoType="dijit.form.TextBox" class="fullside" name="note_'+inx+'"  value="<?php echo $rs["note"]; ?>" type="text" ></td>';
				temp+= '</tr>';
				if($("#identity").val()!="") {
					var identity = $('#identity').val();
					$('#identity').val(identity+','+inx);
				} else {
						$('#identity').val(inx);
				}

			<?php } ?>
			temp+='</table>';
			tmp='<tr id="rowindex'+inx+'">';
			tmp+="</tr>";
			dojo.query("#table_row").append(tmp);
			dojo.html.set(dojo.byId("rowindex"+inx),temp , {
			     parseContent: true,
			});
			HideloadingBlock();
}

</script>
<?php 
	echo $this->render('externalFoot.phtml');
?>